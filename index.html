<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aura AI</title>
    <style>
        :root { --bg: #0a0e27; --accent: #00d4ff; --pro: #ffd700; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0a0e27 0%, #1a1f4b 100%); color: white; height: 100vh; overflow: hidden; }
        .app { max-width: 600px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; position: relative; }
        header { padding: 12px 16px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { font-weight: 900; font-size: 20px; background: linear-gradient(135deg, var(--accent), #7000ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .credits { font-size: 12px; background: rgba(0,212,255,0.1); padding: 4px 12px; border-radius: 20px; border: 1px solid rgba(0,212,255,0.3); cursor: pointer; }
        .content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 200px; }
        .message { max-width: 85%; padding: 12px 16px; border-radius: 18px; margin-bottom: 12px; word-wrap: break-word; font-size: 15px; line-height: 1.5; }
        .message.user { background: linear-gradient(135deg, var(--accent), #7000ff); margin-left: auto; border-bottom-right-radius: 4px; }
        .message.ai { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }
        .message img { max-width: 100%; border-radius: 8px; margin-bottom: 8px; display: block; }
        .input-area { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(10,14,39,0.98); padding: 12px 16px 24px; border-top: 1px solid rgba(255,255,255,0.1); }
        .buttons { display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; }
        button { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; white-space: nowrap; }
        button:active { background: rgba(255,255,255,0.2); }
        .input-row { display: flex; gap: 8px; }
        textarea { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 12px 16px; color: white; resize: none; height: 48px; font-family: inherit; }
        .send { width: 48px; height: 48px; border-radius: 50%; background: var(--accent); color: #000; font-size: 20px; display: flex; align-items: center; justify-content: center; padding: 0; }
        #file-input { display: none; }
        .typing { display: none; padding: 12px 16px; color: rgba(255,255,255,0.6); font-style: italic; }
        .typing.active { display: block; }
        .modal { display: none; position: fixed; inset: 0; background: black; z-index: 1000; flex-direction: column; }
        .modal.active { display: flex; }
        .camera-preview { flex: 1; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .camera-btn { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid rgba(0,0,0,0.3); cursor: pointer; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; border: none; }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="logo">AURA AI</div>
            <div style="display:flex;gap:10px;align-items:center;">
                <div class="credits" id="credits" onclick="toggleAdmin()">20/20</div>
                <button onclick="clearChat()" style="background:rgba(255,100,100,0.2);color:#ff6b6b;">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </header>
        
        <div class="content" id="chat">
            <div class="message ai">
                <b>üì∏ –†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ —Ñ–æ—Ç–æ</b><br><br>
                –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∑–∞–¥–∞—á–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç<br>
                –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 20 —Ä–µ—à–µ–Ω–∏–π –≤ –¥–µ–Ω—å
            </div>
        </div>
        
        <div class="typing" id="typing">–†–µ—à–∞—é...</div>
        
        <div class="input-area">
            <div class="buttons">
                <button onclick="startCamera()">üì∑ –ö–∞–º–µ—Ä–∞</button>
                <button onclick="document.getElementById('file-input').click()">üìé –ì–∞–ª–µ—Ä–µ—è</button>
                <button onclick="buyPro()">‚≠ê PRO</button>
            </div>
            <div class="input-row">
                <textarea id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É..." rows="1"></textarea>
                <button class="send" onclick="sendText()">‚û§</button>
            </div>
        </div>
        
        <input type="file" id="file-input" accept="image/*" onchange="handleFile(this)">
    </div>
    
    <div class="modal" id="camera-modal">
        <div class="camera-preview">
            <video id="video" autoplay playsinline></video>
            <button class="camera-btn" onclick="takePhoto()"></button>
            <button class="close-btn" onclick="stopCamera()">‚úï</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://tgumghgowexcuzlnqnoa.supabase.co/functions/v1';
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRndW1naGdvd2V4Y3V6bG5xbm9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTAzNTEsImV4cCI6MjA4NjcyNjM1MX0.PWSpyTL8w4s567OeulBrmhm3x7T-nqrvfeE0Cp8Jcbw';
        
        let isAdmin = localStorage.getItem('admin') === 'true';
        let isPro = localStorage.getItem('pro') === 'true';
        let messageCount = parseInt(localStorage.getItem('count_' + new Date().toDateString()) || '0');
        let stream = null;
        
        updateCredits();
        
        function updateCredits() {
            const el = document.getElementById('credits');
            if (isAdmin) el.textContent = 'ADMIN';
            else if (isPro) el.textContent = '‚àû';
            else el.textContent = (20 - messageCount) + '/20';
        }
        
        function toggleAdmin() {
            if (isAdmin) {
                localStorage.removeItem('admin');
                isAdmin = false;
                alert('Admin –≤—ã–∫–ª—é—á–µ–Ω');
            } else {
                localStorage.setItem('admin', 'true');
                isAdmin = true;
                alert('Admin –≤–∫–ª—é—á–µ–Ω');
            }
            updateCredits();
        }
        
        function addMessage(text, isUser, imageUrl = null) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = 'message ' + (isUser ? 'user' : 'ai');
            
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                div.appendChild(img);
            }
            
            const span = document.createElement('span');
            span.textContent = text;
            div.appendChild(span);
            
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }
        
        async function sendText() {
            const input = document.getElementById('input');
            const text = input.value.trim();
            if (!text) return;
            
            if (!isPro && !isAdmin && messageCount >= 20) {
                alert('–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω');
                return;
            }
            
            addMessage(text, true);
            input.value = '';
            
            document.getElementById('typing').classList.add('active');
            
            try {
                const res = await fetch(API_URL + '/solve-task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + API_KEY
                    },
                    body: JSON.stringify({message: text, mode: 'tutor'})
                });
                
                const data = await res.json();
                
                if (data.error) throw new Error(data.error);
                
                addMessage(data.answer || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞', false);
                
                if (!isPro && !isAdmin) {
                    messageCount++;
                    localStorage.setItem('count_' + new Date().toDateString(), messageCount);
                    updateCredits();
                }
            } catch (e) {
                addMessage('‚ùå –û—à–∏–±–∫–∞: ' + e.message, false);
            } finally {
                document.getElementById('typing').classList.remove('active');
            }
        }
        
        // ============ –§–û–¢–û ============
        
        async function startCamera() {
            document.getElementById('camera-modal').classList.add('active');
            try {
                stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}});
                document.getElementById('video').srcObject = stream;
            } catch(e) {
                alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
                stopCamera();
            }
        }
        
        function stopCamera() {
            document.getElementById('camera-modal').classList.remove('active');
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
        }
        
        function takePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            stopCamera();
            sendPhoto(imageData);
        }
        
        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => sendPhoto(e.target.result);
            reader.readAsDataURL(file);
            input.value = '';
        }
        
        async function sendPhoto(imageBase64) {
            if (!isPro && !isAdmin && messageCount >= 20) {
                alert('–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω');
                return;
            }
            
            addMessage('üì∑ –§–æ—Ç–æ –∑–∞–¥–∞—á–∏', true, imageBase64);
            document.getElementById('typing').classList.add('active');
            
            try {
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ...');
                
                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint –∏ —Ñ–æ—Ä–º–∞—Ç
                const res = await fetch(API_URL + '/solve-vision', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + API_KEY
                    },
                    body: JSON.stringify({
                        imageBase64: imageBase64,
                        mode: 'tutor'
                    })
                });
                
                console.log('–°—Ç–∞—Ç—É—Å:', res.status);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, JSON –ª–∏ —ç—Ç–æ –∏–ª–∏ —Ç–µ–∫—Å—Ç
                const contentType = res.headers.get('content-type');
                let data;
                
                if (contentType && contentType.includes('application/json')) {
                    data = await res.json();
                    console.log('JSON –æ—Ç–≤–µ—Ç:', data);
                } else {
                    // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª —Ç–µ–∫—Å—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Ç–æ–∫)
                    const text = await res.text();
                    console.log('–¢–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç–≤–µ—Ç:', text);
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ JSON –≤ —Ç–µ–∫—Å—Ç–µ
                    try {
                        const lines = text.split('\n');
                        let result = '';
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                const json = line.replace('data:', '').trim();
                                if (json && json !== '[DONE]') {
                                    const parsed = JSON.parse(json);
                                    const content = parsed.choices?.[0]?.delta?.content || parsed.choices?.[0]?.text || '';
                                    result += content;
                                }
                            }
                        }
                        data = {answer: result || text};
                    } catch(e) {
                        data = {answer: text};
                    }
                }
                
                if (!res.ok) {
                    throw new Error(data.error || data.message || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + res.status);
                }
                
                if (data.error) throw new Error(data.error);
                
                addMessage(data.answer || data.result || data.text || '–ì–æ—Ç–æ–≤–æ!', false);
                
                if (!isPro && !isAdmin) {
                    messageCount++;
                    localStorage.setItem('count_' + new Date().toDateString(), messageCount);
                    updateCredits();
                }
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞:', e);
                addMessage('‚ùå –û—à–∏–±–∫–∞: ' + e.message, false);
            } finally {
                document.getElementById('typing').classList.remove('active');
            }
        }
        
        function clearChat() {
            document.getElementById('chat').innerHTML = '<div class="message ai"><b>üì∏ –†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ —Ñ–æ—Ç–æ</b><br><br>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∑–∞–¥–∞—á–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç</div>';
        }
        
        function buyPro() {
            alert('–ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ–ø–ª–∞—Ç–µ...');
        }
        
        // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        document.getElementById('input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendText();
            }
        });
    </script>
</body>
</html>
