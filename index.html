<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura AI</title>
    <style>
        :root { --bg: #0a0e27; --card: rgba(255,255,255,0.05); --accent: #00d4ff; --pro: #ffd700; --danger: #ff4757; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg); color: white; font-family: -apple-system, sans-serif; height: 100vh; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; height: 100vh; display: flex; flex-direction: column; background: linear-gradient(135deg, #0a0e27 0%, #1a1f4b 100%); }
        header { padding: 12px 16px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 100px; }
        .message { max-width: 85%; padding: 12px 16px; border-radius: 18px; margin-bottom: 12px; font-size: 15px; line-height: 1.5; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { background: linear-gradient(135deg, var(--accent), #7000ff); margin-left: auto; border-bottom-right-radius: 4px; }
        .message.ai { background: var(--card); border: 1px solid rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }
        .message.ai b, .message.ai strong { color: var(--accent); }
        .error-box { background: rgba(255,71,87,0.2); border: 1px solid var(--danger); padding: 12px; border-radius: 12px; color: #ff6b6b; }
        .input-box { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 600px; background: rgba(10,14,39,0.98); border-top: 1px solid rgba(255,255,255,0.1); padding: 12px 16px 24px; display: flex; gap: 10px; }
        input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 12px 16px; border-radius: 24px; font-size: 15px; outline: none; }
        button { background: var(--accent); border: none; color: #000; padding: 12px 24px; border-radius: 24px; font-weight: bold; cursor: pointer; }
        button:disabled { opacity: 0.5; }
        .typing { display: none; color: rgba(255,255,255,0.5); font-style: italic; padding: 10px; }
        .typing.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div style="font-weight: 900; font-size: 20px; color: var(--accent);">AURA AI</div>
            <div style="font-size: 12px; color: rgba(255,255,255,0.6);">Решение задач</div>
        </header>
        
        <div class="content" id="messages">
            <div class="message ai">
                <b>Привет!</b><br><br>
                Введите задачу или нажмите Enter для теста (2+2).
            </div>
        </div>
        
        <div class="typing" id="typing">Печатает...</div>
        
        <div class="input-box">
            <input type="text" id="input" placeholder="Введите задачу..." onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()" id="btn">➤</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            URL: 'https://tgumghgowexcuzlnqnoa.supabase.co/functions/v1/solve-task',
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRndW1naGdvd2V4Y3V6bG5xbm9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTAzNTEsImV4cCI6MjA4NjcyNjM1MX0.PWSpyTL8w4s567OeulBrmhm3x7T-nqrvfeE0Cp8Jcbw'
        };

        function cleanText(text) {
            // Убираем markdown-нумерацию (1. **текст** → <b>текст</b>)
            return text
                .replace(/\d+\.\s*\*\*/g, '<br><b>')  // "2. **" → "<br><b>"
                .replace(/\*\*/g, '</b>')             // закрывающие **
                .replace(/\*/g, '')                   // одиночные *
                .replace(/\n/g, '<br>')               // переносы строк
                .replace(/<br><br><br>/g, '<br><br>') // убираем лишние пустые строки
                .trim();
        }

        async function send() {
            const input = document.getElementById('input');
            const text = input.value.trim() || '2+2';
            const btn = document.getElementById('btn');
            const typing = document.getElementById('typing');
            const messages = document.getElementById('messages');
            
            // Добавляем сообщение пользователя
            messages.innerHTML += `<div class="message user">${text}</div>`;
            input.value = '';
            btn.disabled = true;
            typing.classList.add('active');
            
            // Автоскролл
            messages.scrollTop = messages.scrollHeight;
            
            try {
                const response = await fetch(CONFIG.URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${CONFIG.KEY}`
                    },
                    body: JSON.stringify({
                        message: text,
                        mode: 'tutor',
                        system: 'Решай задачу просто и понятно. Используй HTML-теги <b> для выделения важного. Не используй markdown с цифрами (1., 2.), просто пиши текст с абзацами.'
                    })
                });
                
                if (!response.ok) throw new Error(`Сервер вернул ${response.status}`);
                
                const data = await response.json();
                typing.classList.remove('active');
                
                let answer = data.answer || data.choices?.[0]?.message?.content || 'Нет ответа';
                answer = cleanText(answer);
                
                messages.innerHTML += `<div class="message ai">${answer}</div>`;
                
            } catch (error) {
                typing.classList.remove('active');
                console.error(error);
                
                messages.innerHTML += `
                    <div class="message ai">
                        <div class="error-box">
                            ❌ Ошибка связи с сервером<br><br>
                            Возможные причины:<br>
                            1. Supabase "заснул" (бесплатный тариф) - подождите 10 сек и повторите<br>
                            2. Нет интернета<br>
                            3. Проблема с API-ключом<br><br>
                            <i>Попробуйте еще раз</i>
                        </div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                messages.scrollTop = messages.scrollHeight;
            }
        }
    </script>
</body>
</html>
