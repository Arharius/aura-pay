<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0e27">
    <title>Aura AI</title>
    <style>
        :root { --bg: #0a0e27; --card: rgba(255,255,255,0.05); --accent: #00d4ff; --accent2: #7000ff; --pro: #ffd700; --danger: #ff4757; --warning: #ffa502; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; background: var(--bg); color: white; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; height: 100vh; display: flex; flex-direction: column; background: linear-gradient(135deg, #0a0e27 0%, #1a1f4b 100%); position: relative; }
        
        header { padding: 12px 16px; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .logo { font-weight: 900; font-size: 20px; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .credits { font-size: 12px; color: var(--accent); background: rgba(0,212,255,0.1); padding: 4px 12px; border-radius: 20px; border: 1px solid rgba(0,212,255,0.3); }
        .credits.test { color: #00ff00; border-color: #00ff00; background: rgba(0,255,0,0.1); }
        
        .tabs { display: flex; gap: 8px; padding: 12px; overflow-x: auto; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .tab { flex-shrink: 0; padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .tab.active { background: rgba(0,212,255,0.2); color: var(--accent); border-color: var(--accent); }
        .tab.pro { opacity: 0.6; }
        .tab.pro.locked { opacity: 0.3; position: relative; }
        .tab.pro.locked::after { content: 'üîí'; position: absolute; right: 4px; top: 50%; transform: translateY(-50%); font-size: 10px; }
        
        .content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 180px; }
        .chat { display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 90%; padding: 14px 18px; border-radius: 18px; font-size: 15px; line-height: 1.6; animation: fadeIn 0.3s; word-wrap: break-word; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { background: linear-gradient(135deg, var(--accent), var(--accent2)); align-self: flex-end; border-bottom-right-radius: 4px; }
        .message.ai { background: var(--card); border: 1px solid rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 4px; }
        .message img { max-width: 100%; border-radius: 8px; margin: 8px 0; max-height: 300px; object-fit: contain; display: block; }
        .message b, .message strong { color: var(--accent); }
        
        .disclaimer-box { background: rgba(255,165,2,0.1); border: 1px solid var(--warning); padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 13px; color: rgba(255,255,255,0.9); }
        .crisis-box { background: rgba(255,71,87,0.2); border: 2px solid var(--danger); padding: 16px; border-radius: 12px; margin: 12px 0; text-align: center; }
        .crisis-box h3 { color: var(--danger); margin-bottom: 10px; }
        .crisis-box .phone { display: block; font-size: 24px; font-weight: bold; color: var(--danger); margin: 8px 0; text-decoration: none; }
        .error-box { background: rgba(255,71,87,0.1); border: 1px solid var(--danger); padding: 12px; border-radius: 8px; color: #ff6b6b; font-size: 14px; margin-top: 8px; }
        
        .input-area { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(10,14,39,0.98); border-top: 1px solid rgba(255,255,255,0.1); padding: 12px 16px 24px; }
        .actions { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; }
        .btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; }
        .btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        .input-row { display: flex; gap: 10px; align-items: flex-end; background: rgba(255,255,255,0.05); border-radius: 24px; padding: 8px 16px; border: 1px solid rgba(255,255,255,0.1); }
        textarea { flex: 1; background: none; border: none; color: white; font-size: 15px; padding: 8px 0; max-height: 120px; resize: none; font-family: inherit; outline: none; }
        .send { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); border: none; color: #000; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; }
        .send:disabled { opacity: 0.3; }
        
        .typing { display: none; align-self: flex-start; background: var(--card); padding: 12px 18px; border-radius: 18px; border-bottom-left-radius: 4px; color: rgba(255,255,255,0.6); font-style: italic; }
        .typing.active { display: block; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; }
        .modal.active { display: flex; }
        .camera-preview { flex: 1; background: #000; position: relative; display: flex; align-items: center; justify-content: center; }
        .camera-preview video { max-width: 100%; max-height: 100%; }
        .camera-controls { padding: 20px; display: flex; justify-content: center; gap: 30px; background: rgba(0,0,0,0.8); }
        .snap { width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid rgba(255,255,255,0.3); cursor: pointer; }
        .close { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; }
        
        .paywall { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 2000; flex-direction: column; padding: 24px; overflow-y: auto; }
        .paywall.active { display: flex; }
        .price-card { background: var(--card); border: 1px solid var(--pro); border-radius: 20px; padding: 24px; margin: 20px 0; text-align: center; }
        .buy-btn { width: 100%; padding: 16px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--pro), #ffed4e); color: #000; font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 16px; }
        
        .test-banner { display: none; position: fixed; top: 0; left: 0; right: 0; background: rgba(0,255,0,0.2); color: #00ff00; text-align: center; padding: 4px; font-size: 12px; z-index: 1001; font-weight: bold; }
        .test-banner.active { display: block; }
        
        #file-input { display: none; }
    </style>
</head>
<body>
    <div class="test-banner" id="test-banner">üß™ –¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú</div>
    
    <div class="container">
        <header>
            <div class="logo">AURA AI</div>
            <div style="display:flex;gap:10px;align-items:center;">
                <div class="credits" id="credits">10/10</div>
                <button class="btn" onclick="clearChat()" style="color:#ff6b6b;">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </header>
        
        <div class="tabs">
            <div class="tab active" onclick="setMode('tutor')" data-mode="tutor">üìö –†–µ—à–µ–Ω–∏–µ</div>
            <div class="tab pro" onclick="setMode('lawyer')" data-mode="lawyer">‚öñÔ∏è –Æ—Ä–∏—Å—Ç</div>
            <div class="tab pro" onclick="setMode('psych')" data-mode="psych">üß† –ü—Å–∏—Ö–æ–ª–æ–≥</div>
        </div>
        
        <div class="content" id="chat-container">
            <div class="chat" id="messages"></div>
            <div class="typing" id="typing">–ü–µ—á–∞—Ç–∞–µ—Ç...</div>
        </div>
        
        <div class="input-area">
            <div class="actions">
                <button class="btn" onclick="openCamera()">üì∑ –ö–∞–º–µ—Ä–∞</button>
                <button class="btn" onclick="document.getElementById('file-input').click()">üìé –§–∞–π–ª</button>
                <button class="btn" onclick="showPaywall()">‚≠ê PRO</button>
            </div>
            <div class="input-row">
                <textarea id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É..." rows="1" onkeypress="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();send();}"></textarea>
                <button class="send" id="send-btn" onclick="send()">‚û§</button>
            </div>
        </div>
        
        <input type="file" id="file-input" accept="image/*" onchange="handleFile(event)">
    </div>
    
    <div class="modal" id="camera-modal">
        <button class="close" onclick="closeCamera()">‚úï</button>
        <div class="camera-preview">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas" style="display:none;"></canvas>
        </div>
        <div class="camera-controls">
            <button class="snap" onclick="takePhoto()"></button>
        </div>
    </div>
    
    <div class="paywall" id="paywall">
        <h2 style="text-align:center;color:var(--pro);margin-bottom:20px;">üëë PRO –í–µ—Ä—Å–∏—è</h2>
        <div class="price-card">
            <div style="font-size:32px;font-weight:900;">990 ‚ÇΩ</div>
            <div style="color:rgba(255,255,255,0.6);">30 –¥–Ω–µ–π</div>
            <ul style="text-align:left;margin:16px 0;list-style:none;font-size:14px;">
                <li style="margin:8px 0;">‚úÖ –ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è</li>
                <li style="margin:8px 0;">‚úÖ AI-–Æ—Ä–∏—Å—Ç —Å –¥–∏—Å–∫–ª–µ–π–º–µ—Ä–∞–º–∏</li>
                <li style="margin:8px 0;">‚úÖ AI-–ü—Å–∏—Ö–æ–ª–æ–≥ 24/7</li>
            </ul>
            <button class="buy-btn" onclick="buy()">–ö—É–ø–∏—Ç—å</button>
            <button onclick="closePaywall()" style="background:none;border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.6);padding:12px;border-radius:12px;width:100%;margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            URL: 'https://tgumghgowexcuzlnqnoa.supabase.co/functions/v1/solve-task',
            VISION_URL: 'https://tgumghgowexcuzlnqnoa.supabase.co/functions/v1/solve-vision',
            KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRndW1naGdvd2V4Y3V6bG5xbm9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTAzNTEsImV4cCI6MjA4NjcyNjM1MX0.PWSpyTL8w4s567OeulBrmhm3x7T-nqrvfeE0Cp8Jcbw',
            TEST_PASSWORD: 'aura2024',
            CRISIS: ['—Å—É–∏—Ü–∏–¥','—Å–∞–º–æ—É–±–∏–π—Å—Ç–≤–æ','—É–±–∏—Ç—å —Å–µ–±—è','–ø–æ–∫–æ–Ω—á–∏—Ç—å','–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å','–ø–µ—Ä–µ–¥–æ–∑','–ø–æ–≤–µ—Å–∏—Ç—å—Å—è','–ø—Ä—ã–≥–Ω—É—Ç—å','–ø–æ—Ä–µ–∑–∞—Ç—å—Å—è']
        };
        
        let currentMode = 'tutor';
        let messageCount = 0;
        let isPro = false;
        let testMode = localStorage.getItem('aura_test') === 'true';
        let stream = null;
        let lastTask = {};
        
        const MODES = {
            tutor: {
                free: true,
                system: '–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ. –†–µ—à–∞–π –∑–∞–¥–∞—á–∏ –ø–æ—à–∞–≥–æ–≤–æ, —á–µ—Ç–∫–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å—Ç—ã–µ —Å–∏–º–≤–æ–ª—ã: ‚àö, ¬∞, ¬≤, ¬≥, √ó, √∑. –ù–∏–∫–∞–∫–æ–≥–æ LaTeX. –í—ã–¥–µ–ª—è–π –≤–∞–∂–Ω–æ–µ –∂–∏—Ä–Ω—ã–º. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –Ω—É–º–µ—Ä–∞—Ü–∏—é –≤–∏–¥–∞ "1." –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫.',
                welcome: '<b>üì∏ –†–µ—à–∞–π—Ç–µ –¶–î–ó –∏ –ì–î–ó –ø–æ —Ñ–æ—Ç–æ!</b><br><br>–ë–µ—Å–ø–ª–∞—Ç–Ω–æ 10 —Ä–µ—à–µ–Ω–∏–π –≤ –¥–µ–Ω—å.<br>PRO: 990‚ÇΩ/–º–µ—Å ‚Äî –Æ—Ä–∏—Å—Ç –∏ –ü—Å–∏—Ö–æ–ª–æ–≥.'
            },
            lawyer: {
                free: false,
                system: '–¢—ã AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –ø—Ä–∞–≤–æ–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –¢—ã –ù–ï –∑–∞–º–µ–Ω—è–µ—à—å –∞–¥–≤–æ–∫–∞—Ç–∞. –ü–æ–º–æ–≥–∞–µ—à—å —Å –¥–æ–≥–æ–≤–æ—Ä–∞–º–∏, —à–∞–±–ª–æ–Ω–∞–º–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —Å—Ä–æ–∫–∞–º–∏ –∏—Å–∫–æ–≤–æ–π –¥–∞–≤–Ω–æ—Å—Ç–∏. –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π: "‚ö†Ô∏è –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –Ω–µ –∑–∞–º–µ–Ω—è—é –∞–¥–≤–æ–∫–∞—Ç–∞. –î–ª—è —Å—É–¥–µ–±–Ω—ã—Ö —Ä–∞–∑–±–∏—Ä–∞—Ç–µ–ª—å—Å—Ç–≤ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º—É —é—Ä–∏—Å—Ç—É."',
                welcome: '<b>‚öñÔ∏è AI-–Æ—Ä–∏—Å—Ç: –ü–µ—Ä–≤–∏—á–Ω—ã–π –ø—Ä–∞–≤–æ–≤–æ–π –∞–Ω–∞–ª–∏–∑</b><br><br>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤, —à–∞–±–ª–æ–Ω—ã –∏—Å–∫–æ–≤, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.<br><div class="disclaimer-box">‚ö†Ô∏è –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –Ω–µ –∑–∞–º–µ–Ω—è—é –∞–¥–≤–æ–∫–∞—Ç–∞. –î–ª—è —Å—É–¥–µ–±–Ω—ã—Ö —Ä–∞–∑–±–∏—Ä–∞—Ç–µ–ª—å—Å—Ç–≤ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º—É —é—Ä–∏—Å—Ç—É.</div>'
            },
            psych: {
                free: false,
                system: '–¢—ã AI-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ö–ü–¢ (–∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ-–ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–æ–π —Ç–µ—Ä–∞–ø–∏–∏). –¢—ã –ù–ï —Å—Ç–∞–≤–∏—à—å –¥–∏–∞–≥–Ω–æ–∑—ã –∏ –Ω–µ –∑–∞–º–µ–Ω—è–µ—à—å —Ç–µ—Ä–∞–ø–µ–≤—Ç–∞. –î–∞–µ—à—å —Ç–µ—Ö–Ω–∏–∫–∏ —Å–∞–º–æ–ø–æ–º–æ—â–∏ –ø—Ä–∏ —Ç—Ä–µ–≤–æ–≥–µ, —Å—Ç—Ä–µ—Å—Å–µ, –≤—ã–≥–æ—Ä–∞–Ω–∏–∏. –ü—Ä–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–∏ —Å–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è –∏–ª–∏ —Å—É–∏—Ü–∏–¥–∞ ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –¥–∞–π —Ç–µ–ª–µ—Ñ–æ–Ω 8-800-2000-122 –∏ —Å–∫–∞–∂–∏ —á—Ç–æ —Ç—ã AI –∏ –Ω–µ –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å. –í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–æ–±–∞–≤–ª—è–π: "üí° –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ü—Ä–∏ —Å–µ—Ä—å–µ–∑–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º–∞—Ö –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É."',
                welcome: '<b>üß† AI-–ü—Å–∏—Ö–æ–ª–æ–≥: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ —Ç–µ—Ö–Ω–∏–∫–∏ –ö–ü–¢</b><br><br>–¢—Ä–µ–≤–æ–≥–∞, —Å—Ç—Ä–µ—Å—Å, –≤—ã–≥–æ—Ä–∞–Ω–∏–µ, –ø–∞–Ω–∏—á–µ—Å–∫–∏–µ –∞—Ç–∞–∫–∏.<br><div class="disclaimer-box">‚ö†Ô∏è –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –ü—Ä–∏ –º—ã—Å–ª—è—Ö –æ —Å–∞–º–æ–ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–∏ –∑–≤–æ–Ω–∏—Ç–µ: <b>8-800-2000-122</b> (–∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ)</div>'
            }
        };
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = () => {
            const today = new Date().toDateString();
            messageCount = parseInt(localStorage.getItem('usage_'+today) || '0');
            isPro = localStorage.getItem('aura_pro') === 'true';
            
            const lastMode = localStorage.getItem('last_mode') || 'tutor';
            setMode(lastMode, false);
            
            updateTestMode();
            loadChat(lastMode);
            
            // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤—ã—Å–æ—Ç–∞ textarea
            document.getElementById('input').addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        };
        
        function updateTestMode() {
            document.getElementById('test-banner').classList.toggle('active', testMode);
            const credits = document.getElementById('credits');
            if (testMode) {
                credits.classList.add('test');
                credits.textContent = 'TEST';
            } else if (isPro) {
                credits.textContent = '‚àû/‚àû';
            } else {
                credits.textContent = (10-messageCount) + '/10';
            }
        }
        
        function setMode(mode, save=true) {
            if (!MODES[mode].free && !isPro && !testMode) {
                showPaywall();
                return;
            }
            
            if (save) saveChat(currentMode);
            
            currentMode = mode;
            localStorage.setItem('last_mode', mode);
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-mode="'+mode+'"]').classList.add('active');
            
            loadChat(mode);
        }
        
        function saveChat(mode) {
            const html = document.getElementById('messages').innerHTML;
            localStorage.setItem('chat_'+mode, html);
        }
        
        function loadChat(mode) {
            const saved = localStorage.getItem('chat_'+mode);
            const container = document.getElementById('messages');
            
            if (saved) {
                container.innerHTML = saved;
            } else {
                container.innerHTML = '<div class="message ai">' + MODES[mode].welcome + '</div>';
            }
            scrollToBottom();
        }
        
        function cleanText(text) {
            // –£–±–∏—Ä–∞–µ–º markdown-–Ω—É–º–µ—Ä–∞—Ü–∏—é (1. **—Ç–µ–∫—Å—Ç** ‚Üí <b>—Ç–µ–∫—Å—Ç</b>)
            let cleaned = text
                .replace(/^(\d+)\.\s*\*\*/gm, '<br><b>$1.</b> ')  // "2. **" ‚Üí "<br><b>2.</b> "
                .replace(/\*\*/g, '</b>')                          // –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–µ **
                .replace(/\*/g, '')                                 // –æ–¥–∏–Ω–æ—á–Ω—ã–µ *
                .replace(/^(\d+)\.\s+/gm, '<br><b>$1.</b> ')       // "1. —Ç–µ–∫—Å—Ç" ‚Üí "<br><b>1.</b> —Ç–µ–∫—Å—Ç"
                .replace(/\n/g, '<br>')                             // –ø–µ—Ä–µ–Ω–æ—Å—ã
                .replace(/<br><br><br>/g, '<br><br>')               // –ª–∏—à–Ω–∏–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
                .replace(/^<br>/, '');                              // —É–±—Ä–∞—Ç—å <br> –≤ –Ω–∞—á–∞–ª–µ
            
            return cleaned;
        }
        
        function checkCrisis(text) {
            return CONFIG.CRISIS.some(w => text.toLowerCase().includes(w));
        }
        
        async function send() {
            const input = document.getElementById('input');
            const text = input.value.trim();
            if (!text) return;
            
            // –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
            if (text.startsWith('/testmode ')) {
                const pass = text.split(' ')[1];
                if (pass === CONFIG.TEST_PASSWORD) {
                    testMode = !testMode;
                    localStorage.setItem('aura_test', testMode);
                    updateTestMode();
                    addMessage('üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º ' + (testMode ? '–í–ö–õ' : '–í–´–ö–õ'), 'ai');
                } else {
                    addMessage('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å', 'ai');
                }
                input.value = '';
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏–∑–∏—Å–∞
            if (currentMode === 'psych' && checkCrisis(text)) {
                addMessage(text, 'user');
                input.value = '';
                showCrisis();
                return;
            }
            
            // –õ–∏–º–∏—Ç
            if (currentMode === 'tutor' && !isPro && !testMode && messageCount >= 10) {
                showPaywall();
                return;
            }
            
            addMessage(text, 'user');
            input.value = '';
            document.getElementById('input').style.height = 'auto';
            setTyping(true);
            
            try {
                const response = await fetch(CONFIG.URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + CONFIG.KEY
                    },
                    body: JSON.stringify({
                        message: text,
                        mode: currentMode,
                        system: MODES[currentMode].system,
                        user_pro: isPro || testMode
                    })
                });
                
                if (!response.ok) {
                    if (response.status === 0 || response.status === 503) {
                        throw new Error('Supabase "–∑–∞—Å–Ω—É–ª". –ü–æ–¥–æ–∂–¥–∏—Ç–µ 10 —Å–µ–∫ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ.');
                    }
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + response.status);
                }
                
                const data = await response.json();
                let answer = data.answer || data.error || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞';
                
                if (data.error) throw new Error(data.error);
                
                answer = cleanText(answer);
                addMessage(answer, 'ai');
                
                if (currentMode === 'tutor' && !isPro && !testMode) {
                    messageCount++;
                    updateTestMode();
                }
                
            } catch (err) {
                console.error(err);
                addMessage('<div class="error-box">‚ùå ' + err.message + '<br><br>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥.</div>', 'ai');
            } finally {
                setTyping(false);
            }
        }
        
        function addMessage(content, type, image=null) {
            const div = document.createElement('div');
            div.className = 'message ' + type;
            if (image && type === 'user') {
                div.innerHTML = '<img src="'+image+'"><div>'+content+'</div>';
            } else {
                div.innerHTML = content;
            }
            document.getElementById('messages').appendChild(div);
            scrollToBottom();
            saveChat(currentMode);
        }
        
        function setTyping(active) {
            document.getElementById('typing').classList.toggle('active', active);
            document.getElementById('send-btn').disabled = active;
        }
        
        function scrollToBottom() {
            const container = document.getElementById('chat-container');
            container.scrollTop = container.scrollHeight;
        }
        
        function showCrisis() {
            addMessage('<div class="crisis-box"><h3>üÜò –ö—Ä–∏–∑–∏—Å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è</h3>–Ø AI –∏ –Ω–µ –º–æ–≥—É –ø–æ–º–æ—á—å.<br><a href="tel:88002000122" class="phone">8-800-2000-122</a><div style="font-size:13px;color:rgba(255,255,255,0.7);">–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è (–∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ)</div></div>', 'ai');
        }
        
        // –ö–∞–º–µ—Ä–∞
        async function openCamera() {
            if (currentMode !== 'tutor' && !isPro && !testMode) {
                showPaywall();
                return;
            }
            document.getElementById('camera-modal').classList.add('active');
            try {
                stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
                document.getElementById('video').srcObject = stream;
            } catch(e) {
                alert('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
                closeCamera();
            }
        }
        
        function closeCamera() {
            document.getElementById('camera-modal').classList.remove('active');
            if (stream) { stream.getTracks().forEach(t=>t.stop()); stream=null; }
        }
        
        function takePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const img = canvas.toDataURL('image/jpeg', 0.8);
            closeCamera();
            processImage(img);
        }
        
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => processImage(e.target.result);
            reader.readAsDataURL(file);
        }
        
        async function processImage(imgData) {
            if (currentMode === 'tutor' && !isPro && !testMode && messageCount >= 10) {
                showPaywall();
                return;
            }
            addMessage('[üì∑ –§–æ—Ç–æ]', 'user', imgData);
            setTyping(true);
            
            try {
                const res = await fetch(CONFIG.VISION_URL, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json','Authorization':'Bearer '+CONFIG.KEY},
                    body: JSON.stringify({imageBase64:imgData, mode:currentMode, user_pro:isPro||testMode})
                });
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                const data = await res.json();
                addMessage(cleanText(data.answer), 'ai');
                if (currentMode==='tutor' && !isPro && !testMode) {
                    messageCount++;
                    updateTestMode();
                }
            } catch(e) {
                addMessage('<div class="error-box">‚ùå –û—à–∏–±–∫–∞: ' + e.message + '</div>', 'ai');
            } finally {
                setTyping(false);
            }
        }
        
        function showPaywall() { document.getElementById('paywall').classList.add('active'); }
        function closePaywall() { document.getElementById('paywall').classList.remove('active'); }
        
        function buy() {
            // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã
            localStorage.setItem('aura_pro', 'true');
            isPro = true;
            updateTestMode();
            closePaywall();
            alert('‚úÖ PRO –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!');
        }
        
        function clearChat() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç?')) {
                localStorage.removeItem('chat_'+currentMode);
                loadChat(currentMode);
            }
        }
    </script>
</body>
</html>
