<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0e27">
    <title>Aura AI</title>
    <style>
        :root {
            --bg: #0a0e27;
            --card: rgba(255, 255, 255, 0.05);
            --accent: #00d4ff;
            --accent2: #7000ff;
            --pro: #ffd700;
            --danger: #ff4757;
            --warning: #ffa502;
            --success: #00d26a;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            background: var(--bg); 
            color: white; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; 
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            overflow: hidden;
        }
        .container { 
            width: 100%; 
            max-width: 600px; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f4b 100%);
            position: relative;
        }
        header { 
            padding: 12px 16px; 
            background: rgba(0, 0, 0, 0.3); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .logo { font-weight: 900; font-size: 20px; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .credits { font-size: 12px; color: var(--accent); background: rgba(0, 212, 255, 0.1); padding: 4px 12px; border-radius: 20px; border: 1px solid rgba(0, 212, 255, 0.3); }
        .credits.test { color: #00ff00; border-color: #00ff00; background: rgba(0, 255, 0, 0.1); }
        
        .mode-tabs { display: flex; gap: 8px; padding: 12px; overflow-x: auto; background: rgba(0, 0, 0, 0.2); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .mode-tab { flex-shrink: 0; padding: 8px 16px; border-radius: 20px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.6); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .mode-tab.active { background: rgba(0, 212, 255, 0.2); color: var(--accent); border-color: var(--accent); }
        .mode-tab.pro.locked { opacity: 0.4; position: relative; }
        .mode-tab.pro.locked::after { content: 'üîí'; margin-left: 4px; font-size: 10px; }
        
        .content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 200px; }
        .message { max-width: 90%; padding: 14px 18px; border-radius: 18px; font-size: 15px; line-height: 1.6; margin-bottom: 12px; animation: messageIn 0.3s ease-out; white-space: pre-wrap; word-wrap: break-word; }
        @keyframes messageIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { background: linear-gradient(135deg, var(--accent), var(--accent2)); margin-left: auto; border-bottom-right-radius: 4px; }
        .message.ai { background: var(--card); border: 1px solid rgba(255, 255, 255, 0.1); border-bottom-left-radius: 4px; }
        .message img { max-width: 100%; border-radius: 8px; margin: 8px 0; max-height: 300px; object-fit: contain; display: block; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—É–ª */
        .formula-box { 
            background: rgba(0, 212, 255, 0.1); 
            border-left: 3px solid var(--accent); 
            padding: 10px 12px; 
            margin: 8px 0; 
            border-radius: 0 8px 8px 0; 
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .result-box {
            background: rgba(0, 210, 106, 0.1);
            border: 1px solid var(--success);
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-weight: bold;
            color: var(--success);
        }
        .step { margin: 6px 0; padding-left: 12px; border-left: 2px solid rgba(255, 255, 255, 0.2); }
        
        /* –î–∏—Å–∫–ª–µ–π–º–µ—Ä—ã */
        .disclaimer-box { background: rgba(255, 165, 2, 0.1); border: 1px solid var(--warning); padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 13px; }
        .crisis-box { background: rgba(255, 71, 87, 0.2); border: 2px solid var(--danger); padding: 16px; border-radius: 12px; margin: 12px 0; text-align: center; }
        .crisis-box h3 { color: var(--danger); margin-bottom: 10px; }
        .phone { display: block; font-size: 22px; font-weight: bold; color: var(--danger); margin: 8px 0; text-decoration: none; }
        
        .input-container { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(10, 14, 39, 0.98); border-top: 1px solid rgba(255, 255, 255, 0.1); padding: 12px 16px 24px; }
        .input-actions { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; }
        .action-btn { background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; }
        .action-btn.clear { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
        
        .input-wrapper { display: flex; gap: 10px; align-items: flex-end; background: rgba(255, 255, 255, 0.05); border-radius: 24px; padding: 8px 16px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .message-input { flex: 1; background: none; border: none; color: white; font-size: 15px; padding: 8px 0; max-height: 120px; resize: none; font-family: inherit; outline: none; }
        .send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); border: none; color: #000; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; }
        .send-btn:disabled { opacity: 0.3; background: #666; }
        
        .typing { display: none; padding: 10px 16px; color: rgba(255, 255, 255, 0.6); font-style: italic; }
        .typing.active { display: block; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95); z-index: 1000; flex-direction: column; }
        .modal.active { display: flex; }
        .camera-preview { flex: 1; background: #000; position: relative; display: flex; align-items: center; justify-content: center; }
        .camera-preview video { max-width: 100%; max-height: 100%; object-fit: contain; }
        .camera-controls { padding: 20px; display: flex; justify-content: center; background: rgba(0, 0, 0, 0.8); }
        .camera-btn { width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid rgba(255, 255, 255, 0.3); cursor: pointer; }
        .close-modal { position: absolute; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; }
        
        .paywall { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.98); z-index: 2000; display: none; flex-direction: column; padding: 24px; overflow-y: auto; }
        .paywall.active { display: flex; }
        .paywall-title { font-size: 28px; font-weight: 900; margin-bottom: 8px; color: var(--pro); text-align: center; }
        .pricing-card { background: var(--card); border: 1px solid var(--pro); border-radius: 20px; padding: 24px; margin-bottom: 16px; background: rgba(255, 215, 0, 0.05); }
        .buy-btn { width: 100%; padding: 16px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--pro), #ffed4e); color: #000; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(0, 0, 0, 0.9); color: white; padding: 12px 24px; border-radius: 24px; font-size: 14px; z-index: 3000; transition: transform 0.3s; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        
        #file-input { display: none; }
        .test-banner { display: none; position: fixed; top: 0; left: 0; right: 0; background: rgba(0, 255, 0, 0.2); color: #00ff00; text-align: center; padding: 4px; font-size: 12px; z-index: 1001; font-weight: bold; }
        .test-banner.active { display: block; }
    </style>
</head>
<body>
    <div class="test-banner" id="test-banner">üß™ –¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú</div>

    <div class="container">
        <div id="splash" style="position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <div style="font-size: 48px; font-weight: 900; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">AURA AI</div>
            <div style="color: rgba(255,255,255,0.5); font-size: 14px; margin-top: 10px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="modal" id="camera-modal">
            <button class="close-modal" onclick="closeCamera()">‚úï</button>
            <div class="camera-preview">
                <video id="camera-video" autoplay playsinline></video>
                <canvas id="camera-canvas" style="display:none;"></canvas>
            </div>
            <div class="camera-controls">
                <button class="camera-btn" onclick="takePhoto()"></button>
            </div>
        </div>

        <div class="paywall" id="paywall">
            <div class="paywall-title">üëë PRO</div>
            <div class="pricing-card">
                <div style="font-size: 18px; font-weight: 700; color: var(--pro);">PRO –î–æ—Å—Ç—É–ø</div>
                <div style="font-size: 32px; font-weight: 900; margin: 12px 0;">990 ‚ÇΩ <span style="font-size: 14px;">30 –¥–Ω–µ–π</span></div>
                <ul style="list-style: none; font-size: 14px; color: rgba(255,255,255,0.8); margin: 16px 0;">
                    <li style="margin-bottom: 8px;">‚úÖ –ë–µ–∑–ª–∏–º–∏—Ç</li>
                    <li style="margin-bottom: 8px;">‚úÖ –Æ—Ä–∏—Å—Ç</li>
                    <li style="margin-bottom: 8px;">‚úÖ –ü—Å–∏—Ö–æ–ª–æ–≥</li>
                </ul>
                <button class="buy-btn" onclick="showToast('–û–ø–ª–∞—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">–ö—É–ø–∏—Ç—å</button>
            </div>
            <button onclick="closePaywall()" style="background: none; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.6); padding: 12px; border-radius: 12px; width: 100%;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
        </div>

        <header>
            <div class="logo">AURA AI</div>
            <div style="display:flex;gap:10px;align-items:center;">
                <div class="credits" id="credits-display">10/10</div>
                <button onclick="clearChat()" style="background:rgba(255,107,107,0.2);border:1px solid rgba(255,107,107,0.3);color:#ff6b6b;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;">üóëÔ∏è</button>
            </div>
        </header>
        
        <div class="mode-tabs">
            <div class="mode-tab active" onclick="setMode('tutor')" data-mode="tutor">üìö –†–µ—à–µ–Ω–∏–µ</div>
            <div class="mode-tab pro locked" onclick="setMode('lawyer')" data-mode="lawyer">‚öñÔ∏è –Æ—Ä–∏—Å—Ç</div>
            <div class="mode-tab pro locked" onclick="setMode('psych')" data-mode="psych">üß† –ü—Å–∏—Ö–æ–ª–æ–≥</div>
        </div>

        <div class="content" id="chat-container">
            <div id="messages"></div>
            <div class="typing" id="typing">–†–µ—à–∞—é...</div>
        </div>

        <div class="input-container">
            <div class="input-actions">
                <button class="action-btn" onclick="openCamera()">üì∑ –ö–∞–º–µ—Ä–∞</button>
                <button class="action-btn" onclick="document.getElementById('file-input').click()">üìé –§–∞–π–ª</button>
                <button class="action-btn" onclick="showPaywall()">‚≠ê PRO</button>
                <button class="action-btn clear" onclick="clearChat()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <div class="input-wrapper">
                <textarea class="message-input" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É..." rows="1"></textarea>
                <button class="send-btn" id="send-btn" onclick="sendMessage()">‚û§</button>
            </div>
        </div>
        
        <input type="file" id="file-input" accept="image/*" onchange="handleFile(event)">
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRndW1naGdvd2V4Y3V6bG5xbm9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTAzNTEsImV4cCI6MjA4NjcyNjM1MX0.PWSpyTL8w4s567OeulBrmhm3x7T-nqrvfeE0Cp8Jcbw';
        
        const CONFIG = {
            SUPABASE_URL: 'https://tgumghgowexcuzlnqnoa.supabase.co',
            DAILY_LIMIT: 10,
            TEST_PASSWORD: 'aura2024',
            CRISIS_KEYWORDS: ['—Å—É–∏—Ü–∏–¥', '—Å–∞–º–æ—É–±–∏–π—Å—Ç–≤–æ', '—É–±–∏—Ç—å —Å–µ–±—è', '–ø–æ–∫–æ–Ω—á–∏—Ç—å —Å —Å–æ–±–æ–π', '–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å', '–ø—Ä—ã–≥–Ω—É—Ç—å', '–ø–æ–≤–µ—Å–∏—Ç—å—Å—è'],
            
            MODES: {
                tutor: {
                    name: '–†–µ–ø–µ—Ç–∏—Ç–æ—Ä',
                    free: true,
                    system: `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ. –†–µ—à–∞–π –∑–∞–¥–∞—á–∏ –ø–æ—à–∞–≥–æ–≤–æ.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û - –ü–†–ê–í–ò–õ–ê –ù–ê–ü–ò–°–ê–ù–ò–Ø:
1. –ì—Ä–∞–¥—É—Å—ã –ø–∏—à–∏ –¢–û–õ–¨–ö–û –∫–∞–∫ ¬∞ (—Å–∏–º–≤–æ–ª –≥—Ä–∞–¥—É—Å–∞), –ù–ï ^¬∞ –∏ –ù–ï \\circ
   –ü—Ä–∞–≤–∏–ª—å–Ω–æ: sin 26¬∞
   –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: sin 26^¬∞ –∏–ª–∏ sin 26^\\circ –∏–ª–∏ sin 26\\circ

2. –î—Ä–æ–±–∏ –ø–∏—à–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É: (a)/(b) –∏–ª–∏ a/b
   –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: \\frac{a}{b}

3. –§—É–Ω–∫—Ü–∏–∏ —Å –ø—Ä–æ–±–µ–ª–æ–º: sin 30¬∞, cos 45¬∞

4. –£–º–Ω–æ–∂–µ–Ω–∏–µ: √ó (–∑–Ω–∞–∫ —É–º–Ω–æ–∂–µ–Ω–∏—è)

5. –ó–∞–ø—Ä–µ—â–µ–Ω—ã: \\sin, \\cos, \\frac, \\cdot, \\times, \\sqrt, \\alpha –∏ –¥—Ä—É–≥–∏–µ LaTeX –∫–æ–º–∞–Ω–¥—ã

–°—Ç—Ä—É–∫—Ç—É—Ä–∞:
- –î–∞–Ω–æ
- –§–æ—Ä–º—É–ª–∞ (–ø—Ä–æ—Å—Ç–∞—è)
- –†–µ—à–µ–Ω–∏–µ (–ø–æ—à–∞–≥–æ–≤–æ)
- –û—Ç–≤–µ—Ç: [—á–∏—Å–ª–æ]`,
                    welcome: `<strong>üì∏ –†–µ—à–∞–π—Ç–µ –∑–∞–¥–∞—á–∏ –ø–æ —Ñ–æ—Ç–æ!</strong><br><br>
                        –ü—Ä–∏–º–µ—Ä—ã:<br>
                        ‚Ä¢ <b>cos24¬∞sin2¬∞</b> ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑—É—é –≤ —Å—É–º–º—É<br>
                        ‚Ä¢ <b>sin30¬∞cos60¬∞</b> ‚Äî –≤—ã—á–∏—Å–ª—é –∑–Ω–∞—á–µ–Ω–∏–µ<br><br>
                        –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 10 —Ä–µ—à–µ–Ω–∏–π/–¥–µ–Ω—å`
                },
                lawyer: {
                    name: '–Æ—Ä–∏—Å—Ç',
                    free: false,
                    system: `–¢—ã AI-—é—Ä–∏—Å—Ç –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞. –ù–ï –∑–∞–º–µ–Ω—è–µ—à—å –∞–¥–≤–æ–∫–∞—Ç–∞.

–ú–æ–∂–µ—à—å:
- –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–æ–≥–æ–≤–æ—Ä—ã (–∞—Ä–µ–Ω–¥–∞, –∫—Ä–µ–¥–∏—Ç, —Ä–∞–±–æ—Ç–∞)
- –î–∞–≤–∞—Ç—å —à–∞–±–ª–æ–Ω—ã –ø—Ä–µ—Ç–µ–Ω–∑–∏–π
- –û–±—ä—è—Å–Ω—è—Ç—å —Å—Ç–∞—Ç—å–∏ –ì–ö –†–§, –ñ–ö –†–§

–ù–ï –º–æ–∂–µ—à—å:
- –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—ã–∏–≥—Ä—ã—à –≤ —Å—É–¥–µ
- –î–∞–≤–∞—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —É–≥–æ–ª–æ–≤–Ω—ã–º –¥–µ–ª–∞–º

–í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π –Ω–æ–º–µ—Ä–∞ —Å—Ç–∞—Ç–µ–π.`,
                    welcome: `<strong>‚öñÔ∏è AI-–Æ—Ä–∏—Å—Ç</strong><br><br>
                        ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤<br>
                        ‚Ä¢ –®–∞–±–ª–æ–Ω—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤<br>
                        ‚Ä¢ –†–∞–∑—ä—è—Å–Ω–µ–Ω–∏–µ –∑–∞–∫–æ–Ω–æ–≤<br>
                        <div class="disclaimer-box">‚ö†Ô∏è –ù–µ –∑–∞–º–µ–Ω—è–µ—Ç –∞–¥–≤–æ–∫–∞—Ç–∞</div>`
                },
                psych: {
                    name: '–ü—Å–∏—Ö–æ–ª–æ–≥',
                    free: false,
                    system: `–¢—ã AI-–ø—Å–∏—Ö–æ–ª–æ–≥, –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –ö–ü–¢-—Ç–µ—Ö–Ω–∏–∫–∏.

–ú–æ–∂–µ—à—å:
- –¢–µ—Ö–Ω–∏–∫–∏ —Å–∞–º–æ–ø–æ–º–æ—â–∏ (–¥—ã—Ö–∞–Ω–∏–µ 4-7-8)
- –î–Ω–µ–≤–Ω–∏–∫–∏ –º—ã—Å–ª–µ–π
- –û–±—ä—è—Å–Ω—è—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º—ã —Ç—Ä–µ–≤–æ–≥–∏

–ù–ï –º–æ–∂–µ—à—å:
- –°—Ç–∞–≤–∏—Ç—å –¥–∏–∞–≥–Ω–æ–∑—ã
- –ù–∞–∑–Ω–∞—á–∞—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–∞
- –†–∞–±–æ—Ç–∞—Ç—å —Å –∫—Ä–∏–∑–∏—Å–∞–º–∏ (—Å—É–∏—Ü–∏–¥)

–ü—Ä–∏ –∫—Ä–∏–∑–∏—Å–µ: –Ω–∞–ø—Ä–∞–≤—å –∫ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É.`,
                    welcome: `<strong>üß† AI-–ü—Å–∏—Ö–æ–ª–æ–≥</strong><br><br>
                        ‚Ä¢ –¢–µ—Ö–Ω–∏–∫–∏ –ø—Ä–∏ —Ç—Ä–µ–≤–æ–≥–µ<br>
                        ‚Ä¢ –î–Ω–µ–≤–Ω–∏–∫–∏ –º—ã—Å–ª–µ–π<br>
                        ‚Ä¢ –í—ã–≥–æ—Ä–∞–Ω–∏–µ<br>
                        <div class="disclaimer-box">‚ö†Ô∏è –¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è: 8-800-2000-122</div>`
                }
            }
        };

        // –ü—Ä–æ–º–ø—Ç –¥–ª—è —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π
        const TRIG_PROMPT = `–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏–∏. –ü—Ä–∏ –≤–∏–¥–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ç–∏–ø–∞ cos24¬∞sin2¬∞ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É–ª—ã –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ —Å—É–º–º—É.

**–§–æ—Ä–º—É–ª—ã –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è:**
1. sin Œ± √ó cos Œ≤ = 1/2 [sin(Œ±+Œ≤) + sin(Œ±-Œ≤)]
2. cos Œ± √ó sin Œ≤ = 1/2 [sin(Œ±+Œ≤) - sin(Œ±-Œ≤)]
3. cos Œ± √ó cos Œ≤ = 1/2 [cos(Œ±+Œ≤) + cos(Œ±-Œ≤)]
4. sin Œ± √ó sin Œ≤ = -1/2 [cos(Œ±+Œ≤) - cos(Œ±-Œ≤)]

**–ü—Ä–∞–≤–∏–ª–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (–°–¢–†–û–ì–û):**
- –ì—Ä–∞–¥—É—Å—ã: —Ç–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª ¬∞ (–ù–ï ^¬∞, –ù–ï \\circ)
- –ü—Ä–æ–±–µ–ª—ã: sin 26¬∞ (—Å –ø—Ä–æ–±–µ–ª–æ–º)
- –£–º–Ω–æ–∂–µ–Ω–∏–µ: –∑–Ω–∞–∫ √ó
- –î—Ä–æ–±–∏: 1/2 [sin(Œ±+Œ≤) - sin(Œ±-Œ≤)]
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ: \\frac, \\sin, \\cos, LaTeX

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**
1. –î–∞–Ω–æ: [–≤—ã—Ä–∞–∂–µ–Ω–∏–µ]
2. –§–æ—Ä–º—É–ª–∞ ‚Ññ[N]: [—Ñ–æ—Ä–º—É–ª–∞]
3. –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞: [—á–∏—Å–ª–∞]
4. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ: [–ø–æ—à–∞–≥–æ–≤–æ]
5. –û—Ç–≤–µ—Ç: [–∏—Ç–æ–≥]`;

        let currentMode = 'tutor';
        let messageCount = 0;
        let stream = null;
        let testMode = localStorage.getItem('aura_test') === 'true';
        let isPro = false;
        let lastTask = { question: null, image: null, shortAnswer: null };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('splash').style.display = 'none';
                loadChat(currentMode);
                updateTestMode();
            }, 1000);
            
            const today = new Date().toDateString();
            messageCount = parseInt(localStorage.getItem(`usage_${today}`) || '0');
            updateCredits();
            
            document.getElementById('msg-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        };

        function updateTestMode() {
            const banner = document.getElementById('test-banner');
            const credits = document.getElementById('credits-display');
            if (testMode) {
                banner.classList.add('active');
                credits.textContent = 'TEST';
                credits.classList.add('test');
            } else {
                banner.classList.remove('active');
                credits.classList.remove('test');
            }
        }

        function setMode(mode) {
            const config = CONFIG.MODES[mode];
            if (!config.free && !isPro && !testMode) {
                showToast('üîí –¢–æ–ª—å–∫–æ –≤ PRO');
                showPaywall();
                return;
            }
            
            saveChat();
            currentMode = mode;
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            loadChat(mode);
            showToast(`–†–µ–∂–∏–º: ${config.name}`);
        }

        function saveChat() {
            const html = document.getElementById('messages').innerHTML;
            localStorage.setItem(`chat_${currentMode}`, html);
        }

        function loadChat(mode) {
            const saved = localStorage.getItem(`chat_${mode}`);
            const container = document.getElementById('messages');
            
            if (saved && saved.trim() !== '') {
                container.innerHTML = saved;
            } else {
                container.innerHTML = `<div class="message ai">${CONFIG.MODES[mode].welcome}</div>`;
            }
            document.getElementById('chat-container').scrollTop = 999999;
        }

        function clearChat() {
            if(confirm('–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç?')) {
                localStorage.removeItem(`chat_${currentMode}`);
                document.getElementById('messages').innerHTML = `<div class="message ai">${CONFIG.MODES[currentMode].welcome}</div>`;
                lastTask = { question: null, image: null, shortAnswer: null };
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏–∏
        function isTrigProduct(text) {
            const pattern = /(sin|cos|tg|ctg)\s*\d+.*?(sin|cos|tg|ctg)\s*\d+/i;
            return pattern.test(text) && text.length < 30;
        }

        // –û–ß–ò–°–¢–ö–ê –¢–ï–ö–°–¢–ê –û–¢ ^¬∞ –∏ LaTeX
        function cleanText(text) {
            if (!text) return '';
            
            return text
                // –£–¥–∞–ª—è–µ–º ^¬∞ –∏ –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ ¬∞
                .replace(/\^¬∞/g, '¬∞')
                .replace(/\^\{¬∞\}/g, '¬∞')
                .replace(/\\circ/g, '¬∞')
                .replace(/\\degree/g, '¬∞')
                
                // LaTeX –≤ —Ç–µ–∫—Å—Ç
                .replace(/\\sin/g, 'sin')
                .replace(/\\cos/g, 'cos')
                .replace(/\\tan/g, 'tg')
                .replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '($1)/($2)')
                .replace(/\\times|\\cdot/g, '√ó')
                .replace(/\\sqrt\{([^}]+)\}/g, '‚àö$1')
                .replace(/\\[a-zA-Z]+/g, '')
                .replace(/[\[\]\\]/g, '')
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
                .replace(/\n{3,}/g, '\n\n')
                .trim();
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞
        function formatAnswer(text) {
            // –í—ã–¥–µ–ª—è–µ–º —Ñ–æ—Ä–º—É–ª—ã
            text = text.replace(/((?:sin|cos|tg|ctg)\s+\d+¬∞?\s*√ó\s*(?:sin|cos|tg|ctg)\s+\d+¬∞?)/gi, 
                '<div class="formula-box">$1</div>');
            
            // –í—ã–¥–µ–ª—è–µ–º 1/2[...]
            text = text.replace(/(1\/2\s*\[[^\]]+\])/g, '<div class="formula-box">$1</div>');
            
            // –í—ã–¥–µ–ª—è–µ–º –æ—Ç–≤–µ—Ç
            text = text.replace(/(–û—Ç–≤–µ—Ç:[\s\S]*?)(\d+\.?\d*)/gi, '<div class="result-box">$1$2</div>');
            
            return text;
        }

        function checkCrisis(text) {
            return CONFIG.CRISIS_KEYWORDS.some(k => text.toLowerCase().includes(k));
        }

        function showCrisis() {
            const html = `
                <div class="crisis-box">
                    <h3>üÜò –ö—Ä–∏–∑–∏—Å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è</h3>
                    <div>–Ø AI –∏ –Ω–µ –º–æ–≥—É –ø–æ–º–æ—á—å –≤ —ç—Ç–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.</div>
                    <a href="tel:88002000122" class="phone">8-800-2000-122</a>
                    <div style="font-size: 13px;">–¢–µ–ª–µ—Ñ–æ–Ω –¥–æ–≤–µ—Ä–∏—è (–∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ)</div>
                    <a href="tel:112" class="phone" style="font-size: 20px;">112</a>
                    <div style="font-size: 13px;">–≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ —Å–ª—É–∂–±—ã</div>
                </div>
            `;
            addMessage(html, 'ai');
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            // –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
            if (text.startsWith('/test ')) {
                const pass = text.split(' ')[1];
                if (pass === CONFIG.TEST_PASSWORD) {
                    testMode = !testMode;
                    localStorage.setItem('aura_test', testMode);
                    updateTestMode();
                    showToast(testMode ? 'üß™ –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –í–ö–õ' : 'üîí –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –í–´–ö–õ');
                } else {
                    showToast('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                }
                input.value = '';
                return;
            }

            // –ö—Ä–∏–∑–∏—Å –¥–ª—è –ø—Å–∏—Ö–æ–ª–æ–≥–∞
            if (currentMode === 'psych' && checkCrisis(text)) {
                addMessage(text, 'user');
                input.value = '';
                showCrisis();
                return;
            }

            // –õ–∏–º–∏—Ç
            if (currentMode === 'tutor' && !isPro && !testMode && messageCount >= CONFIG.DAILY_LIMIT) {
                showToast('–õ–∏–º–∏—Ç 10 —Ä–µ—à–µ–Ω–∏–π/–¥–µ–Ω—å');
                showPaywall();
                return;
            }

            addMessage(text, 'user');
            input.value = '';
            document.getElementById('typing').classList.add('active');
            document.getElementById('send-btn').disabled = true;

            try {
                // –í—ã–±–∏—Ä–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
                let systemPrompt = CONFIG.MODES[currentMode].system;
                if (currentMode === 'tutor' && isTrigProduct(text)) {
                    systemPrompt = TRIG_PROMPT;
                    console.log('–ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∏–≥–æ–Ω–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç');
                }

                const response = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/solve-task`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        message: text,
                        mode: currentMode,
                        system: systemPrompt
                    })
                });

                const data = await response.json();
                document.getElementById('typing').classList.remove('active');
                document.getElementById('send-btn').disabled = false;

                if (data.error) throw new Error(data.error);

                // –û—á–∏—â–∞–µ–º –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º
                let answer = cleanText(data.answer);
                answer = formatAnswer(answer);
                
                lastTask = { question: text, image: null, shortAnswer: data.answer.substring(0, 300) };
                
                addMessage(answer, 'ai');

                if (currentMode === 'tutor' && !isPro && !testMode) {
                    messageCount++;
                    const today = new Date().toDateString();
                    localStorage.setItem(`usage_${today}`, messageCount);
                    updateCredits();
                }

            } catch (error) {
                document.getElementById('typing').classList.remove('active');
                document.getElementById('send-btn').disabled = false;
                addMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'ai');
            }
        }

        function addMessage(content, type, image = null) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            
            if (image && type === 'user') {
                div.innerHTML = `<img src="${image}" style="max-width:100%;border-radius:8px;margin-bottom:8px;"><div>${content}</div>`;
            } else {
                div.innerHTML = content;
            }
            
            document.getElementById('messages').appendChild(div);
            document.getElementById('chat-container').scrollTop = 999999;
            saveChat();
        }

        async function openCamera() {
            document.getElementById('camera-modal').classList.add('active');
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                document.getElementById('camera-video').srcObject = stream;
            } catch (err) {
                showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
                closeCamera();
            }
        }

        function closeCamera() {
            document.getElementById('camera-modal').classList.remove('active');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        async function takePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            closeCamera();
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ
            addMessage('üì∑ –§–æ—Ç–æ', 'user', imageData);
            document.getElementById('typing').classList.add('active');
            
            try {
                const response = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/solve-vision`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        imageBase64: imageData,
                        mode: currentMode
                    })
                });
                
                const data = await response.json();
                document.getElementById('typing').classList.remove('active');
                
                if (data.error) throw new Error(data.error);
                
                let answer = cleanText(data.answer);
                answer = formatAnswer(answer);
                addMessage(answer, 'ai');
                
            } catch (error) {
                document.getElementById('typing').classList.remove('active');
                addMessage('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ', 'ai');
            }
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                addMessage('üìé –§–∞–π–ª', 'user', e.target.result);
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–∞–π–ª–∞
                showToast('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω');
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        function updateCredits() {
            if (testMode) return;
            const el = document.getElementById('credits-display');
            const remaining = Math.max(0, CONFIG.DAILY_LIMIT - messageCount);
            el.textContent = `${remaining}/10`;
            if (remaining <= 3) el.style.color = '#ff1744';
        }

        function showPaywall() {
            document.getElementById('paywall').classList.add('active');
        }

        function closePaywall() {
            document.getElementById('paywall').classList.remove('active');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
