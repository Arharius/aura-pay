<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aura AI - –†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .message {
            animation: slideIn 0.3s ease-out;
            word-wrap: break-word;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-dots:after {
            content: '...';
            animation: dots 1.5s steps(5, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        .camera-preview {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 12px;
        }
        
        #videoElement {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 12px;
            background: #000;
        }
        
        .credit-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }
        
        .admin-badge {
            background: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }
        
        pre {
            background: #1e293b;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        code {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
        }
    </style>
</head>
<body class="bg-gray-100">

<!-- –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
<div class="max-w-md mx-auto min-h-screen flex flex-col bg-white shadow-2xl">
    
    <!-- –®–∞–ø–∫–∞ -->
    <div class="glass sticky top-0 z-50 p-4 border-b">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-gray-800">Aura AI</h1>
                <p class="text-xs text-gray-500">–ü–æ–º–æ—â–Ω–∏–∫ –≤ —É—á–µ–±–µ</p>
            </div>
            <div class="flex items-center gap-2">
                <span id="creditBadge" class="credit-badge">‚≠ê <span id="credits">3</span></span>
                <button onclick="toggleAdmin()" class="text-xs text-gray-400 hover:text-gray-600" title="–†–µ–∂–∏–º –∞–¥–º–∏–Ω–∞">
                    ‚öôÔ∏è
                </button>
            </div>
        </div>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º–∞ –∞–¥–º–∏–Ω–∞ -->
        <div id="adminPanel" class="hidden mt-2 p-2 bg-red-50 rounded-lg border border-red-200">
            <span class="admin-badge">ADMIN MODE</span>
            <span class="text-xs text-red-600 ml-2">–ë–∞–ª–∞–Ω—Å: ‚àû</span>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞ -->
    <div class="px-4 py-2 bg-gray-50 border-b flex justify-between items-center">
        <span class="text-xs text-gray-500">–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π</span>
        <button onclick="clearChat()" class="text-xs text-red-500 hover:text-red-700 flex items-center gap-1">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
        </button>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–π -->
    <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-4" style="max-height: calc(100vh - 280px);">
        <!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
        <div class="message bg-blue-50 p-4 rounded-2xl rounded-tl-none border border-blue-100">
            <p class="text-gray-800">üëã –ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É —Ä–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ –ø–æ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ, —Ñ–∏–∑–∏–∫–µ –∏ –¥—Ä—É–≥–∏–º –ø—Ä–µ–¥–º–µ—Ç–∞–º.</p>
            <p class="text-sm text-gray-600 mt-2">üì∏ –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –∑–∞–¥–∞—á–∏ –∏–ª–∏ –Ω–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç–æ–º</p>
            <p class="text-xs text-gray-500 mt-1">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Ä–µ—à–µ–Ω–∏–π: <span id="welcomeCredits">3</span></p>
        </div>
    </div>

    <!-- –û–±–ª–∞—Å—Ç—å –∫–∞–º–µ—Ä—ã (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
    <div id="cameraSection" class="hidden p-4 bg-black">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvas" class="hidden"></canvas>
        <div class="flex gap-2 mt-2">
            <button onclick="capturePhoto()" class="flex-1 bg-white text-black py-3 rounded-lg font-semibold">
                üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button onclick="closeCamera()" class="px-4 bg-red-500 text-white rounded-lg">
                ‚úï
            </button>
        </div>
    </div>

    <!-- –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ -->
    <div id="photoPreview" class="hidden p-4 bg-gray-100 border-t">
        <img id="previewImage" class="camera-preview" src="" alt="Preview">
        <div class="flex gap-2 mt-2">
            <button onclick="sendPhoto()" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-semibold">
                ‚úì –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ä–µ—à–µ–Ω–∏–µ
            </button>
            <button onclick="cancelPhoto()" class="px-4 bg-gray-400 text-white rounded-lg">
                ‚úï
            </button>
        </div>
    </div>

    <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
    <div class="p-4 bg-white border-t shadow-lg">
        
        <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ä–µ–∂–∏–º–∞ -->
        <div class="flex gap-2 mb-3">
            <button onclick="openCamera()" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-medium flex items-center justify-center gap-2 hover:bg-purple-700 transition">
                üì∑ –ö–∞–º–µ—Ä–∞
            </button>
            <label class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-medium flex items-center justify-center gap-2 hover:bg-indigo-700 transition cursor-pointer">
                üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFile(this.files[0])">
            </label>
        </div>

        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ -->
        <div class="flex gap-2">
            <textarea 
                id="messageInput" 
                placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É..." 
                class="flex-1 p-3 border rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"
                rows="2"
                onkeypress="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); sendMessage();}"
            ></textarea>
            <button onclick="sendMessage()" class="bg-blue-600 text-white px-6 rounded-xl font-semibold hover:bg-blue-700 transition">
                ‚û§
            </button>
        </div>
        
        <p class="text-xs text-gray-400 text-center mt-2">–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏</p>
    </div>
</div>

<script>
// ==================== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ====================
let credits = 3;
let isAdmin = false;
let currentStream = null;
let currentPhotoData = null;
const API_URL = 'https://tgumghgowexcuzlnqnoa.supabase.co/functions/v1';

// ==================== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ë–ê–õ–ê–ù–°–û–ú ====================

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤
function updateCredits() {
    const creditsEl = document.getElementById('credits');
    const welcomeEl = document.getElementById('welcomeCredits');
    
    if (isAdmin) {
        creditsEl.textContent = '‚àû';
        if (welcomeEl) welcomeEl.textContent = '‚àû';
    } else {
        creditsEl.textContent = credits;
        if (welcomeEl) welcomeEl.textContent = credits;
    }
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–ø–∏—Å–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤
function spendCredit() {
    if (isAdmin) return true;
    
    if (credits <= 0) {
        addMessage('system', '‚ùå –£ –≤–∞—Å –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è. –ü–æ–ø–æ–ª–Ω–∏—Ç–µ –±–∞–ª–∞–Ω—Å, —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.');
        return false;
    }
    
    credits--;
    updateCredits();
    return true;
}

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∞–¥–º–∏–Ω–∞ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
function toggleAdmin() {
    isAdmin = !isAdmin;
    const panel = document.getElementById('adminPanel');
    
    if (isAdmin) {
        panel.classList.remove('hidden');
    } else {
        panel.classList.add('hidden');
    }
    
    updateCredits();
    addMessage('system', isAdmin ? 'üîì –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤–∫–ª—é—á–µ–Ω' : 'üîí –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω');
}

// ==================== –û–ß–ò–°–¢–ö–ê –ß–ê–¢–ê ====================

function clearChat() {
    const container = document.getElementById('chatContainer');
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    const welcomeHTML = container.innerHTML.split('<!-- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->')[0] || '';
    
    container.innerHTML = `
        <div class="message bg-gray-100 p-3 rounded-lg text-center text-gray-500 text-sm">
            üí¨ –ß–∞—Ç –æ—á–∏—â–µ–Ω. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É!
        </div>
    ` + welcomeHTML;
    
    // –ù–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∫—Ä–µ–¥–∏—Ç–æ–≤!
}

// ==================== –î–û–ë–ê–í–õ–ï–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–ô ====================

function addMessage(type, content, isImage = false) {
    const container = document.getElementById('chatContainer');
    const div = document.createElement('div');
    div.className = 'message';
    
    if (type === 'user') {
        div.className += ' bg-blue-600 text-white p-4 rounded-2xl rounded-tr-none ml-auto max-w-[85%]';
        if (isImage) {
            div.innerHTML = `<img src="${content}" class="rounded-lg max-w-full mb-2" style="max-height: 200px; object-fit: cover;"><p class="text-sm opacity-75">üì∑ –§–æ—Ç–æ –∑–∞–¥–∞—á–∏</p>`;
        } else {
            div.innerHTML = formatText(content);
        }
    } else if (type === 'assistant') {
        div.className += ' bg-gray-100 text-gray-800 p-4 rounded-2xl rounded-tl-none border border-gray-200 max-w-[95%]';
        div.innerHTML = formatText(content);
    } else if (type === 'system') {
        div.className += ' bg-yellow-50 text-yellow-800 p-3 rounded-xl text-center text-sm border border-yellow-200 mx-auto max-w-[90%]';
        div.textContent = content;
    } else if (type === 'loading') {
        div.id = 'loadingMessage';
        div.className += ' bg-gray-50 text-gray-600 p-4 rounded-2xl rounded-tl-none border border-gray-200';
        div.innerHTML = '<span class="loading-dots">–î—É–º–∞—é</span>';
    }
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

// –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (LaTeX, –∫–æ–¥, –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫)
function formatText(text) {
    if (!text) return '';
    
    // –û—á–∏—Å—Ç–∫–∞ LaTeX —Ä–∞–∑–º–µ—Ç–∫–∏ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
    text = cleanLatex(text);
    
    // –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML
    text = text.replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // –ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    
    // –ö—É—Ä—Å–∏–≤
    text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    // –ü–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    text = text.replace(/\n/g, '<br>');
    
    // –ë–ª–æ–∫–∏ –∫–æ–¥–∞
    text = text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
    
    // –ò–Ω–ª–∞–π–Ω-–∫–æ–¥
    text = text.replace(/`([^`]+)`/g, '<code style="background:#f1f5f9;padding:2px 4px;border-radius:4px;">$1</code>');
    
    return text;
}

// –û—á–∏—Å—Ç–∫–∞ LaTeX –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
function cleanLatex(text) {
    if (!text) return '';
    
    // –ó–∞–º–µ–Ω—è–µ–º LaTeX –¥—Ä–æ–±–∏ –Ω–∞ –æ–±—ã—á–Ω—ã–µ
    text = text.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '($1)/($2)');
    text = text.replace(/\\dfrac\{([^}]+)\}\{([^}]+)\}/g, '($1)/($2)');
    
    // –£–±–∏—Ä–∞–µ–º \left –∏ \right
    text = text.replace(/\\left/g, '').replace(/\\right/g, '');
    
    // –ó–∞–º–µ–Ω—è–µ–º \\ –Ω–∞ –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
    text = text.replace(/\\\\/g, '\n');
    
    // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –≤ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏—è—Ö
    text = text.replace(/\$\$/g, '');
    text = text.replace(/\$/g, '');
    
    // –ó–∞–º–µ–Ω—è–µ–º common LaTeX —Å–∏–º–≤–æ–ª—ã
    const replacements = {
        '\\times': '√ó',
        '\\cdot': '¬∑',
        '\\div': '√∑',
        '\\pm': '¬±',
        '\\le': '‚â§',
        '\\leq': '‚â§',
        '\\ge': '‚â•',
        '\\geq': '‚â•',
        '\\ne': '‚â†',
        '\\neq': '‚â†',
        '\\approx': '‚âà',
        '\\infty': '‚àû',
        '\\sqrt': '‚àö',
        '\\pi': 'œÄ',
        '\\alpha': 'Œ±',
        '\\beta': 'Œ≤',
        '\\gamma': 'Œ≥',
        '\\delta': 'Œ¥',
        '\\sum': 'Œ£',
        '\\int': '‚à´',
        '\\to': '‚Üí',
        '\\rightarrow': '‚Üí',
        '\\Rightarrow': '‚áí',
        '\\in': '‚àà',
        '\\subset': '‚äÇ',
        '\\cup': '‚à™',
        '\\cap': '‚à©',
        '\\emptyset': '‚àÖ',
        '\\forall': '‚àÄ',
        '\\exists': '‚àÉ',
        '\\nabla': '‚àá',
        '\\partial': '‚àÇ',
        '\\vec': '',
        '\\mathbf': '',
        '\\mathbb': '',
        '\\text': '',
        '\\quad': ' ',
        '\\,': ' ',
        '\\;': ' ',
        '\\:': ' ',
        '\\!': '',
        '\\{': '{',
        '\\}': '}'
    };
    
    for (const [latex, symbol] of Object.entries(replacements)) {
        text = text.split(latex).join(symbol);
    }
    
    return text;
}

// ==================== –†–ê–ë–û–¢–ê –° –ö–ê–ú–ï–†–û–ô ====================

async function openCamera() {
    const section = document.getElementById('cameraSection');
    const video = document.getElementById('videoElement');
    
    try {
        currentStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' }, 
            audio: false 
        });
        video.srcObject = currentStream;
        section.classList.remove('hidden');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:', error);
        addMessage('system', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
        
        // Fallback –Ω–∞ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—É—é –∫–∞–º–µ—Ä—É
        try {
            currentStream = await navigator.mediaDevices.getUserMedia({ 
                video: true, 
                audio: false 
            });
            video.srcObject = currentStream;
            section.classList.remove('hidden');
        } catch (fallbackError) {
            addMessage('system', '‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É –∏–∑ –≥–∞–ª–µ—Ä–µ–∏.');
        }
    }
}

function closeCamera() {
    const section = document.getElementById('cameraSection');
    const video = document.getElementById('videoElement');
    
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
        currentStream = null;
    }
    
    video.srcObject = null;
    section.classList.add('hidden');
}

function capturePhoto() {
    const video = document.getElementById('videoElement');
    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas –∫–∞–∫ —É –≤–∏–¥–µ–æ
    canvas.width = video.videoWidth || 1280;
    canvas.height = video.videoHeight || 720;
    
    // –†–∏—Å—É–µ–º –∫–∞–¥—Ä
    context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ base64
    currentPhotoData = canvas.toDataURL('image/jpeg', 0.9);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
    document.getElementById('previewImage').src = currentPhotoData;
    document.getElementById('photoPreview').classList.remove('hidden');
    
    closeCamera();
}

function cancelPhoto() {
    currentPhotoData = null;
    document.getElementById('photoPreview').classList.add('hidden');
    document.getElementById('previewImage').src = '';
}

// ==================== –û–ë–†–ê–ë–û–¢–ö–ê –§–ê–ô–õ–û–í ====================

function handleFile(file) {
    if (!file) return;
    
    if (!file.type.startsWith('image/')) {
        addMessage('system', '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        currentPhotoData = e.target.result;
        document.getElementById('previewImage').src = currentPhotoData;
        document.getElementById('photoPreview').classList.remove('hidden');
    };
    reader.readAsDataURL(file);
}

// ==================== –û–¢–ü–†–ê–í–ö–ê –°–û–û–ë–©–ï–ù–ò–ô ====================

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const text = input.value.trim();
    
    if (!text) return;
    
    if (!spendCredit()) return;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    addMessage('user', text);
    input.value = '';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    addMessage('loading');
    
    try {
        const response = await fetch(`${API_URL}/solve-task`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                text: text,
                mode: 'text'
            })
        });
        
        // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingEl = document.getElementById('loadingMessage');
        if (loadingEl) loadingEl.remove();
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        addMessage('assistant', data.solution || data.result || '–†–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        
        const loadingEl = document.getElementById('loadingMessage');
        if (loadingEl) loadingEl.remove();
        
        addMessage('system', `‚ùå –û—à–∏–±–∫–∞: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.`);
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—Ä–µ–¥–∏—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if (!isAdmin) {
            credits++;
            updateCredits();
        }
    }
}

async function sendPhoto() {
    if (!currentPhotoData) return;
    
    if (!spendCredit()) return;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ –≤ —á–∞—Ç
    addMessage('user', currentPhotoData, true);
    
    // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
    document.getElementById('photoPreview').classList.add('hidden');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    addMessage('loading');
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ solve-vision
        const response = await fetch(`${API_URL}/solve-vision`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                image: currentPhotoData,
                prompt: '–†–µ—à–∏ —ç—Ç—É –∑–∞–¥–∞—á—É –ø–æ—à–∞–≥–æ–≤–æ. –û–±—ä—è—Å–Ω–∏ –∫–∞–∂–¥—ã–π —à–∞–≥ –ø–æ–¥—Ä–æ–±–Ω–æ.'
            })
        });
        
        // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const loadingEl = document.getElementById('loadingMessage');
        if (loadingEl) loadingEl.remove();
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        addMessage('assistant', data.solution || data.result || data.text || '–ó–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞');
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ:', error);
        
        const loadingEl = document.getElementById('loadingMessage');
        if (loadingEl) loadingEl.remove();
        
        addMessage('system', `‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ç—á–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º.`);
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—Ä–µ–¥–∏—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
        if (!isAdmin) {
            credits++;
            updateCredits();
        }
    } finally {
        currentPhotoData = null;
    }
}

// ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================

document.addEventListener('DOMContentLoaded', function() {
    updateCredits();
    console.log('Aura AI –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ö—Ä–µ–¥–∏—Ç–æ–≤:', credits);
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
window.onerror = function(msg, url, lineNo, columnNo, error) {
    console.error('–û—à–∏–±–∫–∞:', msg, '–Ω–∞ —Å—Ç—Ä–æ–∫–µ', lineNo);
    return false;
};
</script>

</body>
</html>
