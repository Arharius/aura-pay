<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aura AI</title>
    <style>
        :root { --bg: #0a0e27; --accent: #00d4ff; --pro: #ffd700; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0a0e27 0%, #1a1f4b 100%); color: white; height: 100vh; overflow: hidden; }
        .app { max-width: 600px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; position: relative; }
        header { padding: 12px 16px; background: rgba(0,0,0,0.3); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .logo { font-weight: 900; font-size: 20px; background: linear-gradient(135deg, var(--accent), #7000ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .credits { font-size: 12px; background: rgba(0,212,255,0.1); padding: 4px 12px; border-radius: 20px; border: 1px solid rgba(0,212,255,0.3); cursor: pointer; }
        .content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 200px; }
        .message { max-width: 85%; padding: 12px 16px; border-radius: 18px; margin-bottom: 12px; word-wrap: break-word; font-size: 15px; line-height: 1.5; }
        .message.user { background: linear-gradient(135deg, var(--accent), #7000ff); margin-left: auto; border-bottom-right-radius: 4px; }
        .message.ai { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-bottom-left-radius: 4px; }
        .message img { max-width: 100%; border-radius: 8px; margin-bottom: 8px; display: block; }
        .input-area { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(10,14,39,0.98); padding: 12px 16px 24px; border-top: 1px solid rgba(255,255,255,0.1); }
        .buttons { display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; }
        button { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; white-space: nowrap; }
        button:active { background: rgba(255,255,255,0.2); }
        .input-row { display: flex; gap: 8px; }
        textarea { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 12px 16px; color: white; resize: none; height: 48px; font-family: inherit; }
        .send { width: 48px; height: 48px; border-radius: 50%; background: var(--accent); color: #000; font-size: 20px; display: flex; align-items: center; justify-content: center; padding: 0; }
        #file-input { display: none; }
        .typing { display: none; padding: 12px 16px; color: rgba(255,255,255,0.6); font-style: italic; }
        .typing.active { display: block; }
        .modal { display: none; position: fixed; inset: 0; background: black; z-index: 1000; flex-direction: column; }
        .modal.active { display: flex; }
        .camera-preview { flex: 1; position: relative; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .camera-btn { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid rgba(0,0,0,0.3); cursor: pointer; }
        .close-btn { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; border: none; }
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: white; padding: 12px 24px; border-radius: 24px; font-size: 14px; z-index: 3000; display: none; }
        .toast.show { display: block; }
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="logo">AURA AI</div>
            <div style="display:flex;gap:10px;align-items:center;">
                <div class="credits" id="credits" onclick="toggleAdmin()">20/20</div>
                <button onclick="clearChat()" style="background:rgba(255,100,100,0.2);color:#ff6b6b;">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </header>
        
        <div class="content" id="chat">
            <div class="message ai">
                <b>üì∏ –†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ —Ñ–æ—Ç–æ</b><br><br>
                –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∑–∞–¥–∞—á–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç<br>
                –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 20 —Ä–µ—à–µ–Ω–∏–π –≤ –¥–µ–Ω—å
            </div>
        </div>
        
        <div class="typing" id="typing">–†–µ—à–∞—é...</div>
        
        <div class="input-area">
            <div class="buttons">
                <button onclick="startCamera()">üì∑ –ö–∞–º–µ—Ä–∞</button>
                <button onclick="document.getElementById('file-input').click()">üìé –ì–∞–ª–µ—Ä–µ—è</button>
                <button onclick="buyPro()">‚≠ê PRO</button>
            </div>
            <div class="input-row">
                <textarea id="input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É..." rows="1"></textarea>
                <button class="send" onclick="sendText()">‚û§</button>
            </div>
        </div>
        
        <input type="file" id="file-input" accept="image/*" onchange="handleFile(this)">
    </div>
    
    <div class="modal" id="camera-modal">
        <div class="camera-preview">
            <video id="video" autoplay playsinline></video>
            <button class="camera-btn" onclick="takePhoto()"></button>
            <button class="close-btn" onclick="stopCamera()">‚úï</button>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const API_URL = 'https://tgumghgowexcuzlnqnoa.supabase.co/functions/v1';
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRndW1naGdvd2V4Y3V6bG5xbm9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTAzNTEsImV4cCI6MjA4NjcyNjM1MX0.PWSpyTL8w4s567OeulBrmhm3x7T-nqrvfeE0Cp8Jcbw';
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è isAdmin
        let isAdmin = localStorage.getItem('aura_admin') === 'true';
        let isPro = localStorage.getItem('aura_pro_expiry') && new Date() <= new Date(localStorage.getItem('aura_pro_expiry'));
        let messageCount = parseInt(localStorage.getItem('count_' + new Date().toDateString()) || '0');
        let stream = null;
        
        updateCredits();
        
        function updateCredits() {
            const el = document.getElementById('credits');
            if (isAdmin) {
                el.textContent = 'ADMIN';
                el.style.background = 'rgba(255,215,0,0.2)';
                el.style.borderColor = '#ffd700';
                el.style.color = '#ffd700';
            } else if (isPro) {
                el.textContent = '‚àû/‚àû';
            } else {
                el.textContent = (20 - messageCount) + '/20';
            }
        }
        
        function toggleAdmin() {
            if (isAdmin) {
                localStorage.removeItem('aura_admin');
                isAdmin = false;
                showToast('ADMIN –≤—ã–∫–ª—é—á–µ–Ω');
            } else {
                showToast('–í–∫–ª—é—á–∏—Ç–µ —á–µ—Ä–µ–∑ –∫–æ–Ω—Å–æ–ª—å: localStorage.setItem("aura_admin","true")');
            }
            updateCredits();
        }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        function addMessage(text, isUser, imageUrl = null) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = 'message ' + (isUser ? 'user' : 'ai');
            
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                div.appendChild(img);
                const span = document.createElement('span');
                span.textContent = text;
                div.appendChild(span);
            } else {
                div.textContent = text;
            }
            
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }
        
        // ‚úÖ –¢–ï–ö–°–¢ - –∏—Å–ø–æ–ª—å–∑—É–µ–º solve-task (JSON)
        async function sendText() {
            const input = document.getElementById('input');
            const text = input.value.trim();
            if (!text) return;
            
            if (!isPro && !isAdmin && messageCount >= 20) {
                showToast('–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω');
                return;
            }
            
            addMessage(text, true);
            input.value = '';
            
            document.getElementById('typing').classList.add('active');
            
            try {
                const res = await fetch(API_URL + '/solve-task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + API_KEY
                    },
                    body: JSON.stringify({message: text, mode: 'tutor'})
                });
                
                const data = await res.json();
                
                if (!res.ok || data.error) throw new Error(data.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                
                addMessage(cleanText(data.answer), false);
                
                if (!isPro && !isAdmin) {
                    messageCount++;
                    localStorage.setItem('count_' + new Date().toDateString(), messageCount);
                    updateCredits();
                }
            } catch (e) {
                addMessage('‚ùå –û—à–∏–±–∫–∞: ' + e.message, false);
            } finally {
                document.getElementById('typing').classList.remove('active');
            }
        }
        
        // ‚úÖ –§–û–¢–û - –∏—Å–ø–æ–ª—å–∑—É–µ–º solve-vision (STREAM)
        async function takePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth || 1280;
            canvas.height = video.videoHeight || 720;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            stopCamera();
            await processImage(imageData, 'üì∑ –§–æ—Ç–æ');
        }
        
        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => processImage(e.target.result, 'üìé –§–æ—Ç–æ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏');
            reader.readAsDataURL(file);
            input.value = '';
        }
        
        // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ (stream)
        async function processImage(imageBase64, label) {
            if (!isPro && !isAdmin && messageCount >= 20) {
                showToast('–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω');
                return;
            }
            
            addMessage(label, true, imageBase64);
            document.getElementById('typing').classList.add('active');
            
            try {
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ solve-vision...');
                
                const res = await fetch(API_URL + '/solve-vision', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + API_KEY
                    },
                    body: JSON.stringify({
                        imageBase64: imageBase64,
                        mode: 'tutor'
                    })
                });
                
                console.log('–°—Ç–∞—Ç—É—Å:', res.status, 'Content-Type:', res.headers.get('content-type'));
                
                // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –æ—Ç–≤–µ—Ç–∞
                const contentType = res.headers.get('content-type') || '';
                
                if (!res.ok) {
                    // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞, –ø—Ä–æ–±—É–µ–º –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∫–∞–∫ JSON
                    const errorData = await res.json().catch(() => ({error: '–û—à–∏–±–∫–∞ ' + res.status}));
                    throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                if (contentType.includes('application/json')) {
                    // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –≤–µ—Ä–Ω—É–ª—Å—è JSON (–Ω–µ stream)
                    const data = await res.json();
                    addMessage(cleanText(data.answer || data.text || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞'), false);
                } else {
                    // ‚úÖ STREAM –æ–±—Ä–∞–±–æ—Ç–∫–∞ (SSE)
                    const reader = res.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let fullText = '';
                    
                    // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ—Ç–æ–∫–∞
                    const chat = document.getElementById('chat');
                    const div = document.createElement('div');
                    div.className = 'message ai';
                    div.innerHTML = '<em>–î—É–º–∞—é...</em>';
                    chat.appendChild(div);
                    chat.scrollTop = chat.scrollHeight;
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop(); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É
                        
                        for (const line of lines) {
                            if (line.startsWith('data:')) {
                                const jsonStr = line.replace('data:', '').trim();
                                if (jsonStr === '[DONE]') continue;
                                
                                try {
                                    const parsed = JSON.parse(jsonStr);
                                    const content = parsed.choices?.[0]?.delta?.content || 
                                                   parsed.choices?.[0]?.text || '';
                                    if (content) {
                                        fullText += content;
                                        div.textContent = cleanText(fullText);
                                        chat.scrollTop = chat.scrollHeight;
                                    }
                                } catch (e) {
                                    // –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –±–∏—Ç—ã–µ JSON
                                }
                            }
                        }
                    }
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞—Ç–æ–∫
                    if (buffer.startsWith('data:')) {
                        try {
                            const jsonStr = buffer.replace('data:', '').trim();
                            if (jsonStr && jsonStr !== '[DONE]') {
                                const parsed = JSON.parse(jsonStr);
                                const content = parsed.choices?.[0]?.delta?.content || '';
                                fullText += content;
                                div.textContent = cleanText(fullText);
                            }
                        } catch (e) {}
                    }
                    
                    if (!fullText) {
                        div.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –æ—Ç–≤–µ—Ç';
                    }
                }
                
                if (!isPro && !isAdmin) {
                    messageCount++;
                    localStorage.setItem('count_' + new Date().toDateString(), messageCount);
                    updateCredits();
                }
                
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞:', e);
                addMessage('‚ùå –û—à–∏–±–∫–∞: ' + e.message, false);
            } finally {
                document.getElementById('typing').classList.remove('active');
            }
        }
        
        function cleanText(text) {
            if (!text || typeof text !== 'string') return '';
            return text
                .replace(/\\[\[\]\(\)]/g, '')
                .replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '($1/$2)')
                .replace(/\\sqrt/g, '‚àö')
                .replace(/\\cdot/g, '√ó')
                .replace(/\\div/g, '√∑')
                .replace(/\\pi/g, 'œÄ')
                .replace(/\\/g, '')
                .trim();
        }
        
        async function startCamera() {
            document.getElementById('camera-modal').classList.add('active');
            try {
                stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}});
                document.getElementById('video').srcObject = stream;
            } catch(e) {
                showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
                stopCamera();
            }
        }
        
        function stopCamera() {
            document.getElementById('camera-modal').classList.remove('active');
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
        }
        
        function clearChat() {
            document.getElementById('chat').innerHTML = '<div class="message ai"><b>üì∏ –†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á –ø–æ —Ñ–æ—Ç–æ</b><br><br>–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∑–∞–¥–∞—á–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç</div>';
        }
        
        function buyPro() {
            showToast('–ü–µ—Ä–µ—Ö–æ–¥ –∫ –æ–ø–ª–∞—Ç–µ...');
        }
        
        document.getElementById('input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendText();
            }
        });
    </script>
</body>
</html>
