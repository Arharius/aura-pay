<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aura AI ‚Äî –£–º–Ω—ã–π –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç</title>
    <style>
        body {
            background-color: #0f0c29;
            background-image: linear-gradient(315deg, #0f0c29 0%, #302b63 74%, #24243e 100%);
            color: white; font-family: -apple-system, sans-serif;
            margin: 0; padding: 10px; display: flex; flex-direction: column; min-height: 100vh; box-sizing: border-box;
        }
        .container { max-width: 600px; margin: 0 auto; width: 100%; display: none; flex-direction: column; flex-grow: 1; }
        h1 { font-size: 24px; margin: 0; background: linear-gradient(#00d2ff, #3a7bd5); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; }
        
        /* –ó–ê–ì–õ–£–®–ö–ê (Offline) */
        #offline-screen {
            display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f0c29; z-index: 999999; flex-direction: column; align-items: center; 
            justify-content: center; text-align: center;
        }

        .weather-banner {
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(0, 210, 255, 0.2);
            border-radius: 15px; padding: 12px; margin: 10px 0; text-align: center; font-size: 14px;
        }

        #chat-container {
            flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 12px;
            padding: 15px; margin-bottom: 15px; background: rgba(0,0,0,0.2); border-radius: 20px;
        }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.5; }
        .msg-user { align-self: flex-end; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); }
        .msg-ai { align-self: flex-start; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.05); }

        .input-area { background: rgba(255,255,255,0.08); border-radius: 22px; padding: 15px; margin-bottom: 15px; }
        textarea { width: 100%; background: transparent; border: none; color: white; font-size: 16px; resize: none; outline: none; min-height: 44px; }
        .btn-send { background: #9733ee; color: white; border: none; padding: 10px 22px; border-radius: 14px; font-weight: bold; cursor: pointer; }
        .btn-send:disabled { opacity: 0.7; cursor: not-allowed; }

        .pricing-card {
            background: linear-gradient(135deg, rgba(151, 51, 238, 0.1), rgba(218, 34, 255, 0.1));
            border: 1px solid rgba(218, 34, 255, 0.3); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px;
        }

        footer { padding: 15px; font-size: 10px; color: #8a8d91; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div id="offline-screen">
    <div style="font-size: 80px; margin-bottom: 20px;">üì°</div>
    <h1 style="color: #ff4b2b; margin: 0;">–ù–ï–¢ –°–í–Ø–ó–ò</h1>
    <p style="color: #fff; padding: 0 40px; margin: 15px 0 25px;">–î–ª—è —Ä–∞–±–æ—Ç—ã –Ω—É–∂–µ–Ω –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.</p>
    <button class="btn-send" onclick="forceEnter()">–í–û–ô–¢–ò</button>
</div>

<div class="container" id="app-content">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1>Aura AI</h1>
        <button onclick="clearHistory()" style="background:none; border:none; color:#ff4b2b; font-size:11px; cursor:pointer;">–û–ß–ò–°–¢–ò–¢–¨</button>
    </div>

    <div class="weather-banner">
        <div id="weather-text">üìç –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–∞...</div>
    </div>

    <div id="chat-container"></div>

    <div class="input-area" id="input-block">
        <div id="role-display" style="font-size:10px; color:#00ff88; margin-bottom:8px;">‚óè –†–ï–ñ–ò–ú: –û–ë–©–ò–ô –ü–û–ú–û–©–ù–ò–ö</div>
        <textarea id="user-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å..."></textarea>
        <div style="display:flex; justify-content:right; margin-top:10px;">
            <button class="btn-send" onclick="sendToAI()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div class="pricing-card" id="pricing">
        <h3 style="margin:0; font-size:16px;">–¢–∞—Ä–∏—Ñ Aura Pro</h3>
        <div style="font-size:24px; font-weight:900; color:#da22ff; margin:5px 0;">990 ‚ÇΩ / –º–µ—Å</div>
        <button class="btn-send" style="width:100%;" onclick="initPayment()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å PRO</button>
    </div>

    <footer>–ò–ü –®–∫—É—Ä–µ–Ω–∫–æ –ê–Ω–¥—Ä–µ–π –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á</footer>
</div>

<script>
    // === –í–°–¢–ê–í–¨ –ö–õ–Æ–ß–ò ===
    const SUPABASE_URL = 'https://tgumghgowexcuzlnqnoa.supabase.co'; 
    const SUPABASE_KEY = 'sb_publishable_O7VDJMTOc45bFS8l6K-ilg_pkQ2PCax'; 
    const DEEPSEEK_KEY = 'sk-a5e1d303aeee4ecdade7de51b6768a58';
    const PAYMENT_LINK = 'live_jsfec4_iwjcgWGj-49Uhr4-Bdfbuqd6uXj9BnZmlV7U'; 
    // ====================

    let userId = localStorage.getItem('aura_user_id') || ('user_' + Math.random().toString(36).substr(2, 9));
    localStorage.setItem('aura_user_id', userId);
    let messageCount = parseInt(localStorage.getItem('aura_count') || '0');
    let history = JSON.parse(localStorage.getItem('aura_history') || '[]');
    let isPro = false;
    let weatherLoaded = false;

    function checkNetworkAuto() {
        if (navigator.onLine) {
            document.getElementById('offline-screen').style.display = 'none';
            document.getElementById('app-content').style.display = 'flex';
            if (!weatherLoaded) {
                getLocationAndWeather();
                checkProStatus();
                weatherLoaded = true;
            }
        }
    }

    function forceEnter() {
        document.getElementById('offline-screen').style.display = 'none';
        document.getElementById('app-content').style.display = 'flex';
        getLocationAndWeather();
    }

    window.addEventListener('online', checkNetworkAuto);

    // 1. –õ–û–ö–ê–õ–¨–ù–ê–Ø –ü–û–ì–û–î–ê (GPS)
    function getLocationAndWeather() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (position) => {
                fetchLocalWeather(position.coords.latitude, position.coords.longitude);
            }, () => fetchLocalWeather(55.75, 37.61)); // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        } else {
            fetchLocalWeather(55.75, 37.61);
        }
    }

    async function fetchLocalWeather(lat, lon) {
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const data = await res.json();
            document.getElementById('weather-text').innerText = `üìç –ó–∞ –æ–∫–Ω–æ–º: ${Math.round(data.current_weather.temperature)}¬∞C`;
        } catch(e) { 
            document.getElementById('weather-text').innerText = "üìç –ü–æ–≥–æ–¥–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞"; 
        }
    }

    // 2. –£–ú–ù–´–ô –ü–û–ò–°–ö –ü–û–ì–û–î–´ (–ü–û –í–°–ï–ú–£ –ú–ò–†–£)
    async function searchWorldWeather(text) {
        // –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫: –∏—â–µ–º "–ø–æ–≥–æ–¥–∞ –≤ ..." –∏ –±–µ—Ä–µ–º –≤—Å—ë, —á—Ç–æ –ø–æ—Å–ª–µ
        const match = text.match(/(?:–ø–æ–≥–æ–¥–∞|—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞)\s+(?:–≤|–≤–æ)\s+([–∞-—è–ê-–Øa-zA-Z-\s]+)/i);
        
        if (match && match[1]) {
            const cityQuery = match[1].trim();
            console.log("–ò—â–µ–º –≥–æ—Ä–æ–¥:", cityQuery);
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Nominatim (OpenStreetMap) - –æ–Ω –ø–æ–Ω–∏–º–∞–µ—Ç –ø–∞–¥–µ–∂–∏!
                const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityQuery)}&format=json&limit=1`);
                const geoData = await geoRes.json();
                
                if (geoData && geoData.length > 0) {
                    const { lat, lon, display_name } = geoData[0];
                    
                    // –°–∫–∞—á–∏–≤–∞–µ–º –ø–æ–≥–æ–¥—É –ø–æ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
                    const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                    const weatherData = await weatherRes.json();
                    
                    return `(–°–ò–°–¢–ï–ú–ù–û–ï –°–û–û–ë–©–ï–ù–ò–ï: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ ${display_name}. –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ç–∞–º —Å–µ–π—á–∞—Å: ${weatherData.current_weather.temperature}¬∞C, –≤–µ—Ç–µ—Ä ${weatherData.current_weather.windspeed} –∫–º/—á).`;
                }
            } catch (e) {
                console.log("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–∞");
            }
        }
        return "";
    }

    // –û–°–¢–ê–õ–¨–ù–û–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ
    async function checkProStatus() {
        try {
            const res = await fetch(`${SUPABASE_URL}/rest/v1/payments?user_id=eq.${userId}&status=eq.success`, {
                headers: { 'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}` }
            });
            const data = await res.json();
            if (data && data.length > 0) {
                isPro = true;
                document.getElementById('pricing').style.display = 'none';
                document.getElementById('role-display').innerText += ' (PRO)';
            }
        } catch (e) {}
    }

    function renderHistory() {
        const container = document.getElementById('chat-container');
        if (history.length === 0) container.innerHTML = '<div class="msg msg-ai">–ü—Ä–∏–≤–µ—Ç! –Ø Aura AI. –°–ø—Ä–æ—Å–∏ –º–µ–Ω—è –ø—Ä–æ –ø–æ–≥–æ–¥—É –≤ –ª—é–±–æ–º –≥–æ—Ä–æ–¥–µ!</div>';
        else container.innerHTML = history.map(m => `<div class="msg ${m.role === 'user' ? 'msg-user' : 'msg-ai'}">${m.text}</div>`).join('');
        container.scrollTop = container.scrollHeight;
    }

    async function sendToAI() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if (!text) return;
        if (!navigator.onLine) { alert("–ù–µ—Ç —Å–µ—Ç–∏"); return; }

        if (messageCount >= 3 && !isPro) {
            alert("–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω. –ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ PRO.");
            return;
        }

        history.push({role: 'user', text: text});
        renderHistory();
        input.value = "...";

        // 1. –ë–µ—Ä–µ–º –ø–æ–≥–æ–¥—É —é–∑–µ—Ä–∞
        const localW = document.getElementById('weather-text').innerText;
        
        // 2. –ò—â–µ–º –≥–æ—Ä–æ–¥ –≤ —Ç–µ–∫—Å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ú–∞–≥–∏—è —Å Nominatim)
        const cityWeatherInfo = await searchWorldWeather(text);

        // 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é
        let systemMsg = `–¢—ã Aura AI. –¢–≤–æ—è –ª–æ–∫–∞–ª—å–Ω–∞—è –ø–æ–≥–æ–¥–∞: "${localW}".`;
        
        if (cityWeatherInfo) {
            // –ï—Å–ª–∏ –º—ã –Ω–∞—à–ª–∏ –ø–æ–≥–æ–¥—É –≤ –¥—Ä—É–≥–æ–º –≥–æ—Ä–æ–¥–µ - –ø–µ—Ä–µ–¥–∞–µ–º –µ—ë –±–æ—Ç—É
            systemMsg += ` ${cityWeatherInfo} –û—Ç–≤–µ—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –∏—Å–ø–æ–ª—å–∑—É—è —ç—Ç–∏ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ.`;
        } else {
            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏
            systemMsg += " –ï—Å–ª–∏ —Å–ø—Ä–æ—Å—è—Ç –ø—Ä–æ –ø–æ–≥–æ–¥—É –≤ –¥—Ä—É–≥–æ–º –≥–æ—Ä–æ–¥–µ –∏ —è –Ω–µ –ø–µ—Ä–µ–¥–∞–ª –¥–∞–Ω–Ω—ã–µ, —Å–∫–∞–∂–∏, —á—Ç–æ –Ω–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ —ç—Ç–æ—Ç –≥–æ—Ä–æ–¥.";
        }

        try {
            const res = await fetch('https://api.deepseek.com/v1/chat/completions', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${DEEPSEEK_KEY}`},
                body: JSON.stringify({
                    model: "deepseek-chat", 
                    messages: [{role: "system", content: systemMsg}, {role: "user", content: text}]
                })
            });
            const data = await res.json();
            history.push({role: 'ai', text: data.choices[0].message.content});
            messageCount++;
            localStorage.setItem('aura_count', messageCount);
            localStorage.setItem('aura_history', JSON.stringify(history));
            renderHistory();
        } catch (e) { alert("–û—à–∏–±–∫–∞ API"); }
        input.value = "";
    }

    function initPayment() {
        if (PAYMENT_LINK && PAYMENT_LINK.includes('http')) window.location.href = PAYMENT_LINK;
        else alert("–°—Å—ã–ª–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞");
    }

    function clearHistory() { if(confirm("–û—á–∏—Å—Ç–∏—Ç—å?")) { localStorage.clear(); location.reload(); } }

    window.onload = () => {
        checkNetworkAuto();
        renderHistory();
    };
</script>
</body>
</html>
