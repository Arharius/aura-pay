<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0e27">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Aura AI - —É–º–Ω—ã–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á –ø–æ —Ñ–æ—Ç–æ">
    
    <link rel="manifest" href="manifest.json">
    
    <title>Aura AI - –†–µ—à–µ–Ω–∏–µ –¶–î–ó</title>
    <script src='https://unpkg.com/tesseract.js@4.1.1/dist/tesseract.min.js'></script>
    <style>
        :root { --bg: #0a0e27; --card: rgba(255,255,255,0.05); --accent: #00d4ff; --accent2: #7000ff; --pro: #ffd700; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        
        /* –û–¢–ö–õ–Æ–ß–ê–ï–ú PULL-TO-REFRESH */
        html, body {
            overscroll-behavior-y: none;
            touch-action: pan-y;
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        body {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f4b 100%);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #splash { 
            position: fixed; 
            inset: 0; 
            background: var(--bg); 
            z-index: 9999; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }
        .splash-logo { font-size: 48px; font-weight: 900; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .loader { width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; overflow: hidden; margin-top: 20px; }
        .loader-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s; }
        .app { 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            opacity: 0; 
            transition: opacity 0.3s;
            overflow: hidden;
            position: relative;
        }
        .app.visible { opacity: 1; }
        header { 
            padding: 12px 16px; 
            background: rgba(0,0,0,0.3); 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            flex-shrink: 0;
        }
        .logo { font-weight: 900; font-size: 20px; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .credits { font-size: 12px; color: var(--accent); background: rgba(0,212,255,0.1); padding: 4px 12px; border-radius: 20px; border: 1px solid rgba(0,212,255,0.3); }
        .mode-tabs { 
            display: flex; 
            gap: 8px; 
            padding: 12px; 
            overflow-x: auto; 
            background: rgba(0,0,0,0.2); 
            border-bottom: 1px solid rgba(255,255,255,0.1);
            flex-shrink: 0;
        }
        .mode-tab { flex-shrink: 0; padding: 8px 16px; border-radius: 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: rgba(255,255,255,0.6); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .mode-tab.active { background: rgba(0,212,255,0.2); color: var(--accent); border-color: var(--accent); }
        .mode-tab.pro { opacity: 0.6; }
        .content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 16px; 
            padding-bottom: 180px;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
        }
        .chat-container { display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 90%; padding: 14px 18px; border-radius: 18px; font-size: 15px; line-height: 1.5; animation: messageIn 0.3s ease-out; }
        @keyframes messageIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { background: linear-gradient(135deg, var(--accent), var(--accent2)); align-self: flex-end; border-bottom-right-radius: 4px; }
        .message.ai { background: var(--card); border: 1px solid rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 4px; }
        .message img { max-width: 100%; border-radius: 8px; margin: 8px 0; max-height: 300px; object-fit: contain; }
        .input-container { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: rgba(10,14,39,0.98); 
            backdrop-filter: blur(20px); 
            border-top: 1px solid rgba(255,255,255,0.1); 
            padding: 12px 16px 24px 16px;
            z-index: 100;
        }
        .input-actions { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .action-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 6px; cursor: pointer; white-space: nowrap; }
        .action-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.2); }
        .input-wrapper { display: flex; gap: 10px; align-items: flex-end; background: rgba(255,255,255,0.05); border-radius: 24px; padding: 8px 16px; border: 1px solid rgba(255,255,255,0.1); }
        .message-input { flex: 1; background: none; border: none; color: white; font-size: 15px; padding: 8px 0; max-height: 120px; resize: none; font-family: inherit; outline: none; }
        .message-input::placeholder { color: rgba(255,255,255,0.4); }
        .send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); border: none; color: #000; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; }
        .send-btn:disabled { opacity: 0.3; background: #666; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; flex-direction: column; }
        .modal.active { display: flex; }
        .camera-preview { flex: 1; background: #000; position: relative; display: flex; align-items: center; justify-content: center; }
        .camera-preview video, .camera-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .camera-controls { padding: 20px; display: flex; justify-content: center; gap: 30px; background: rgba(0,0,0,0.8); }
        .camera-btn { width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid rgba(255,255,255,0.3); cursor: pointer; }
        .close-modal { position: absolute; top: 20px; right: 20px; background: rgba(0,0,0,0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; }
        .paywall { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 2000; display: none; flex-direction: column; padding: 24px; overflow-y: auto; }
        .paywall.active { display: flex; }
        .paywall-title { font-size: 28px; font-weight: 900; margin-bottom: 8px; color: var(--pro); text-align: center; }
        .pricing-card { background: var(--card); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 24px; margin-bottom: 16px; border-color: var(--pro); background: rgba(255,215,0,0.05); }
        .price { font-size: 32px; font-weight: 900; margin: 12px 0; }
        .price-features { list-style: none; font-size: 14px; color: rgba(255,255,255,0.8); margin: 16px 0; }
        .price-features li { margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .buy-btn { width: 100%; padding: 16px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--pro), #ffed4e); color: #000; font-weight: bold; font-size: 16px; cursor: pointer; }
        .typing-indicator { display: none; align-self: flex-start; background: var(--card); padding: 12px 18px; border-radius: 18px; border-bottom-left-radius: 4px; align-items: center; gap: 8px; color: rgba(255,255,255,0.6); }
        .typing-indicator.active { display: flex; }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dots span { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(0,0,0,0.9); color: white; padding: 12px 24px; border-radius: 24px; font-size: 14px; z-index: 3000; transition: transform 0.3s; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        #file-input { display: none; }
        #offline-screen { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 9998; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        
        /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø—Ä–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–µ */
        .content, .chat-container {
            user-select: none;
            -webkit-user-select: none;
        }
        .message {
            user-select: text;
            -webkit-user-select: text;
        }
    </style>
</head>
<body>

<div id="offline-screen">
    <div style="font-size: 64px; margin-bottom: 20px;">üì°</div>
    <h2 style="margin-bottom: 12px; color: white;">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
    <p style="color: rgba(255,255,255,0.6); margin-bottom: 30px; max-width: 300px;">–î–ª—è —Ä–∞–±–æ—Ç—ã Aura AI —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç</p>
    <button onclick="checkConnection()" style="background: var(--accent); color: #000; border: none; padding: 12px 32px; border-radius: 24px; font-weight: bold; font-size: 16px; cursor: pointer;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
</div>

<div id="splash">
    <div class="splash-logo">AURA AI</div>
    <div style="color: rgba(255,255,255,0.5); font-size: 14px; margin-top: 10px;">–†–µ—à–µ–Ω–∏–µ –¶–î–ó –∏ –ì–î–ó</div>
    <div class="loader"><div class="loader-bar" id="loader-bar"></div></div>
</div>

<div class="modal" id="camera-modal">
    <button class="close-modal" onclick="closeCamera()">‚úï</button>
    <div class="camera-preview">
        <video id="camera-video" autoplay playsinline></video>
        <canvas id="camera-canvas" style="display:none;"></canvas>
    </div>
    <div class="camera-controls">
        <button class="camera-btn" onclick="takePhoto()"></button>
    </div>
</div>

<div class="paywall" id="paywall">
    <div style="text-align: center; margin-bottom: 24px;">
        <div class="paywall-title">üëë PRO –í–µ—Ä—Å–∏—è</div>
        <div style="color: rgba(255,255,255,0.6);">–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</div>
    </div>
    
    <div class="pricing-card">
        <div style="font-size: 18px; font-weight: 700; color: var(--pro);">PRO –î–æ—Å—Ç—É–ø</div>
        <div class="price">990 ‚ÇΩ <span style="font-size: 14px; color: rgba(255,255,255,0.5);">30 –¥–Ω–µ–π</span></div>
        <ul class="price-features">
            <li>‚úÖ –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á</li>
            <li>‚úÖ –Æ—Ä–∏—Å—Ç (—Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏)</li>
            <li>‚úÖ –ü—Å–∏—Ö–æ–ª–æ–≥ (–≥–ª—É–±–æ–∫–∞—è —Ç–µ—Ä–∞–ø–∏—è)</li>
            <li>‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä—É–∫–æ–ø–∏—Å–∏</li>
        </ul>
        <button class="buy-btn" onclick="initPayment()">–ö—É–ø–∏—Ç—å PRO</button>
    </div>
    
    <button onclick="closePaywall()" style="background: none; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.6); padding: 12px; border-radius: 12px; width: 100%;">
        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ (20/–¥–µ–Ω—å)
    </button>
</div>

<div class="app" id="app">
    <header>
        <div class="logo">AURA AI</div>
        <div class="credits" id="credits-display">20/20</div>
    </header>

    <div class="mode-tabs">
        <div class="mode-tab active" onclick="setMode('tutor')" data-mode="tutor">üìö –†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á</div>
        <div class="mode-tab pro" onclick="setMode('lawyer')" data-mode="lawyer">‚öñÔ∏è –Æ—Ä–∏—Å—Ç</div>
        <div class="mode-tab pro" onclick="setMode('psych')" data-mode="psych">üß† –ü—Å–∏—Ö–æ–ª–æ–≥</div>
    </div>

    <div class="content" id="chat-container">
        <div class="chat-container" id="messages">
            <div class="message ai" id="welcome-message">
                <strong>üì∏ –†–µ—à–∞–π—Ç–µ –¶–î–ó –∏ –ì–î–ó –ø–æ —Ñ–æ—Ç–æ!</strong><br><br>
                –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 20 —Ä–µ—à–µ–Ω–∏–π –≤ –¥–µ–Ω—å<br>
                PRO: 990‚ÇΩ / 30 –¥–Ω–µ–π + –Æ—Ä–∏—Å—Ç + –ü—Å–∏—Ö–æ–ª–æ–≥<br><br>
                1. –ù–∞–∂–º–∏—Ç–µ <b>–ö–∞–º–µ—Ä–∞</b> ‚Äî —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –∑–∞–¥–∞—á—É<br>
                2. –ò–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤—Ä—É—á–Ω—É—é<br>
                3. –ü–æ–ª—É—á–∏—Ç–µ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ
            </div>
        </div>
        <div class="typing-indicator" id="typing">
            <span>–†–µ—à–∞—é...</span>
            <div class="typing-dots"><span></span><span></span><span></span></div>
        </div>
    </div>

    <div class="input-container">
        <div class="input-actions">
            <button class="action-btn" onclick="openCamera()">üì∑ –ö–∞–º–µ—Ä–∞</button>
            <button class="action-btn" onclick="document.getElementById('file-input').click()">üìé –§–∞–π–ª</button>
            <button class="action-btn" onclick="showPaywall()">‚≠ê PRO</button>
        </div>
        <div class="input-wrapper">
            <textarea class="message-input" id="msg-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É..." rows="1"></textarea>
            <button class="send-btn" id="send-btn" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <input type="file" id="file-input" accept="image/*,.pdf,.txt" onchange="handleFile(event)">
</div>

<div class="toast" id="toast"></div>

<script>
// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('touchmove', function(e) {
    if (e.target.closest('.content')) {
        e.preventDefault();
    }
}, { passive: false });

const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRndW1naGdvd2V4Y3V6bG5xbm9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTAzNTEsImV4cCI6MjA4NjcyNjM1MX0.PWSpyTL8w4s567OeulBrmhm3x7T-nqrvfeE0Cp8Jcbw';

const CONFIG = {
    SUPABASE_URL: 'https://tgumghgowexcuzlnqnoa.supabase.co',
    SUPABASE_KEY: SUPABASE_KEY,
    DAILY_LIMIT: 20,
    MODES: {
        tutor: { name: '–†–µ–ø–µ—Ç–∏—Ç–æ—Ä', free: true, system: '–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–µ—à–µ–Ω–∏—é —à–∫–æ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á (–¶–î–ó, –ì–î–ó). –†–µ—à–∞–π –ø–æ—à–∞–≥–æ–≤–æ, –æ–±—ä—è—Å–Ω—è–π –∫–∞–∂–¥—ã–π —à–∞–≥ –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º. –î–ª—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏: –ø–æ–∫–∞–∑—ã–≤–∞–π —Ñ–æ—Ä–º—É–ª—ã.' },
        lawyer: { name: '–Æ—Ä–∏—Å—Ç', free: false, system: '–¢—ã —Å—Ç–∞—Ä—à–∏–π —é—Ä–∏—Å—Ç —Å 15-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º –≤ –†–§. –î–∞–≤–∞–π –î–ï–¢–ê–õ–¨–ù–´–ï –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Å—Ç–∞—Ç—å—è–º–∏ –ì–ö –†–§, –ù–ö –†–§, –¢–ö –†–§. –î–∞–≤–∞–π —Å—Ä–æ–∫–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.' },
        psych: { name: '–ü—Å–∏—Ö–æ–ª–æ–≥', free: false, system: '–¢—ã –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –ö–ü–¢. –ü—Ä–æ–≤–æ–¥–∏ —Ç–µ—Ä–∞–ø–∏—é: –¥–∞–≤–∞–π –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è, –¥–Ω–µ–≤–Ω–∏–∫–∏ –º—ã—Å–ª–µ–π, —Ç–µ—Ö–Ω–∏–∫–∏ —Å–∞–º–æ–ø–æ–º–æ—â–∏. –ì–ª—É–±–∏–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞.' }
    }
};

let currentMode = 'tutor';
let messageCount = 0;
let stream = null;

function checkProStatus() {
    const proExpiry = localStorage.getItem('aura_pro_expiry');
    if (!proExpiry) return false;
    
    const expiryDate = new Date(proExpiry);
    const now = new Date();
    
    if (now > expiryDate) {
        localStorage.removeItem('aura_pro');
        localStorage.removeItem('aura_pro_expiry');
        return false;
    }
    return true;
}

let isPro = checkProStatus();

function updateOnlineStatus() {
    const offlineScreen = document.getElementById('offline-screen');
    const isOnline = navigator.onLine;
    
    if (!isOnline) {
        offlineScreen.style.display = 'flex';
    } else {
        offlineScreen.style.display = 'none';
        if (offlineScreen.dataset.wasOffline === 'true') {
            showToast('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
        }
    }
    offlineScreen.dataset.wasOffline = (!isOnline).toString();
}

function checkConnection() {
    showToast('–ü—Ä–æ–≤–µ—Ä–∫–∞...');
    if (navigator.onLine) {
        updateOnlineStatus();
        showToast('‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –µ—Å—Ç—å');
    } else {
        showToast('‚ùå –ù–µ—Ç —Å–≤—è–∑–∏');
    }
}

window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// –°–û–•–†–ê–ù–ï–ù–ò–ï –ß–ê–¢–ê –ü–ï–†–ï–î –ó–ê–ö–†–´–¢–ò–ï–ú
window.addEventListener('beforeunload', function() {
    const messages = document.getElementById('messages').innerHTML;
    const chatData = {
        html: messages,
        mode: currentMode,
        count: messageCount,
        time: new Date().toISOString()
    };
    localStorage.setItem('aura_chat_backup', JSON.stringify(chatData));
});

window.onload = () => {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('SW registered:', reg.scope))
            .catch(err => console.log('SW error:', err));
    }
    
    // –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ß–ê–¢–ê –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
    try {
        const savedChat = localStorage.getItem('aura_chat_backup');
        if (savedChat) {
            const chatData = JSON.parse(savedChat);
            const savedTime = new Date(chatData.time);
            const now = new Date();
            const hoursDiff = (now - savedTime) / (1000 * 60 * 60);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –º–µ–Ω—å—à–µ 24 —á–∞—Å–æ–≤
            if (hoursDiff < 24 && chatData.html) {
                document.getElementById('messages').innerHTML = chatData.html;
                // –£–¥–∞–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —á–∞—Ç
                const welcome = document.getElementById('welcome-message');
                if (welcome && chatData.html.includes('message ai')) {
                    welcome.style.display = 'none';
                }
            } else {
                localStorage.removeItem('aura_chat_backup');
            }
            
            if (chatData.mode) {
                currentMode = chatData.mode;
                document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                const activeTab = document.querySelector(`[data-mode="${currentMode}"]`);
                if (activeTab) activeTab.classList.add('active');
            }
        }
    } catch (e) {
        console.log('Error restoring chat:', e);
    }
    
    updateOnlineStatus();
    const today = new Date().toDateString();
    messageCount = parseInt(localStorage.getItem(`usage_${today}`) || '0');
    updateCredits();
    
    let progress = 0;
    const interval = setInterval(() => {
        progress += 20;
        document.getElementById('loader-bar').style.width = progress + '%';
        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                document.getElementById('splash').style.opacity = '0';
                setTimeout(() => document.getElementById('splash').remove(), 500);
                document.getElementById('app').classList.add('visible');
            }, 500);
        }
    }, 200);
    
    document.getElementById('msg-input').addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    
    document.getElementById('msg-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
};

function setMode(mode) {
    const modeConfig = CONFIG.MODES[mode];
    if (!modeConfig.free && !isPro) {
        showPaywall();
        const html = `<div style="background: rgba(255,215,0,0.05); border: 1px solid rgba(255,215,0,0.3); border-radius: 16px; padding: 20px; text-align: center; margin: 10px 0;">
            <h3 style="color: var(--pro); margin-bottom: 10px;">${modeConfig.name} PRO</h3>
            <p style="color: rgba(255,255,255,0.7); font-size: 14px; margin-bottom: 15px;">${mode === 'lawyer' ? '–°–ª–æ–∂–Ω—ã–µ –ø—Ä–∞–≤–æ–≤—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –∑–∞–∫–æ–Ω—ã, —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∑–∞—â–∏—Ç—ã.' : '–ì–ª—É–±–æ–∫–∞—è —Ç–µ—Ä–∞–ø–∏—è –ö–ü–¢, —Ä–∞–±–æ—Ç–∞ —Å —Ç—Ä–∞–≤–º–∞–º–∏, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω.'}</p>
            <button onclick="showPaywall()" style="background: linear-gradient(135deg, var(--pro), #ffed4e); color: #000; border: none; padding: 10px 24px; border-radius: 20px; font-weight: bold; cursor: pointer;">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –∑–∞ 990‚ÇΩ</button>
        </div>`;
        addMessage(html, 'ai');
        return;
    }
    currentMode = mode;
    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–µ–∂–∏–º–∞
    const messages = document.getElementById('messages').innerHTML;
    localStorage.setItem('aura_chat_backup', JSON.stringify({
        html: messages,
        mode: currentMode,
        count: messageCount,
        time: new Date().toISOString()
    }));
}

async function sendMessage(imageData = null) {
    if (!navigator.onLine) {
        showToast('–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
        document.getElementById('offline-screen').style.display = 'flex';
        return;
    }
    
    const input = document.getElementById('msg-input');
    const text = input.value.trim();
    if (!text && !imageData) return;
    
    if (!isPro && messageCount >= CONFIG.DAILY_LIMIT) {
        showToast('–õ–∏–º–∏—Ç 20 —Ä–µ—à–µ–Ω–∏–π/–¥–µ–Ω—å. –ö—É–ø–∏—Ç–µ PRO.');
        showPaywall();
        return;
    }
    
    // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ (–Ω–∞—Ç–∏–≤–Ω–æ–µ –æ—â—É—â–µ–Ω–∏–µ)
    if (navigator.vibrate) navigator.vibrate(50);
    
    addMessage(imageData ? '[–§–æ—Ç–æ] ' + text : text, 'user', imageData);
    input.value = '';
    input.style.height = 'auto';
    
    document.getElementById('typing').classList.add('active');
    document.getElementById('send-btn').disabled = true;
    
    try {
        const url = `${CONFIG.SUPABASE_URL}/functions/v1/solve-task`;
        const response = await fetch(url, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${SUPABASE_KEY}`
            },
            body: JSON.stringify({
                mode: currentMode,
                message: text || '–†–µ—à–∏ –∑–∞–¥–∞—á—É –Ω–∞ —Ñ–æ—Ç–æ',
                system: CONFIG.MODES[currentMode].system,
                user_pro: isPro
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        document.getElementById('typing').classList.remove('active');
        
        if (data.error) throw new Error(data.error);
        if (!data.answer) throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
        
        addMessage(data.answer, 'ai');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞—Ç –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
        const messages = document.getElementById('messages').innerHTML;
        localStorage.setItem('aura_chat_backup', JSON.stringify({
            html: messages,
            mode: currentMode,
            count: messageCount,
            time: new Date().toISOString()
        }));
        
        if (!isPro) {
            messageCount++;
            localStorage.setItem(`usage_${new Date().toDateString()}`, messageCount);
            updateCredits();
        }
    } catch (error) {
        document.getElementById('typing').classList.remove('active');
        addMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'ai');
    } finally {
        document.getElementById('send-btn').disabled = false;
    }
}

async function openCamera() {
    if (currentMode !== 'tutor' && !isPro) {
        showToast('–ö–∞–º–µ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ä–µ–∂–∏–º–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ PRO');
        showPaywall();
        return;
    }
    if (!isPro && messageCount >= CONFIG.DAILY_LIMIT) {
        showPaywall();
        return;
    }
    document.getElementById('camera-modal').classList.add('active');
    try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        document.getElementById('camera-video').srcObject = stream;
    } catch (err) {
        showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
        closeCamera();
    }
}

function takePhoto() {
    const video = document.getElementById('camera-video');
    const canvas = document.getElementById('camera-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0);
    const imageData = canvas.toDataURL('image/jpeg', 0.8);
    closeCamera();
    
    showToast('–†–∞—Å–ø–æ–∑–Ω–∞—é —Ç–µ–∫—Å—Ç...');
    Tesseract.recognize(imageData, 'rus+eng').then(({ data: { text } }) => {
        document.getElementById('msg-input').value = text;
        showToast('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—Å—Ç –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ');
    });
}

function closeCamera() {
    document.getElementById('camera-modal').classList.remove('active');
    if (stream) { stream.getTracks().forEach(track => track.stop()); stream = null; }
}

function handleFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    if (file.size > 10 * 1024 * 1024) { showToast('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π'); return; }
    const reader = new FileReader();
    reader.onload = (e) => {
        if (file.type.startsWith('image/')) {
            Tesseract.recognize(e.target.result, 'rus+eng').then(({ data: { text } }) => {
                document.getElementById('msg-input').value = text;
                showToast('–¢–µ–∫—Å—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω');
            });
        } else {
            document.getElementById('msg-input').value = e.target.result.substring(0, 1000);
        }
    };
    reader.readAsDataURL(file);
}

async function initPayment() {
    showToast('–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...');
    
    try {
        const userId = localStorage.getItem('user_id') || 'user_' + Date.now();
        localStorage.setItem('user_id', userId);
        
        const returnUrl = 'https://arharius.github.io/aura-pay/?payment=success';
        
        const response = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/create-payment`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${SUPABASE_KEY}` 
            },
            body: JSON.stringify({ 
                user_id: userId, 
                return_url: returnUrl 
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        if (data.confirmation_url) {
            window.location.href = data.confirmation_url;
        } else {
            throw new Error('–ù–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É');
        }
        
    } catch (err) { 
        showToast('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: ' + err.message); 
    }
}

function addMessage(content, type, image = null) {
    const div = document.createElement('div');
    div.className = `message ${type}`;
    div.innerHTML = image && type === 'user' ? `<img src="${image}" style="max-width:100%;margin-bottom:8px;border-radius:8px;"><br>${content}` : content;
    document.getElementById('messages').appendChild(div);
    
    // –ü–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
    const container = document.getElementById('chat-container');
    container.scrollTo({
        top: container.scrollHeight,
        behavior: 'smooth'
    });
}

function updateCredits() {
    const el = document.getElementById('credits-display');
    el.textContent = isPro ? '‚àû/‚àû' : `${CONFIG.DAILY_LIMIT - messageCount}/${CONFIG.DAILY_LIMIT}`;
    if (!isPro && messageCount >= 15) el.style.color = '#ff1744';
}

function showPaywall() { document.getElementById('paywall').classList.add('active'); }
function closePaywall() { document.getElementById('paywall').classList.remove('active'); }
function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); }

const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('payment') === 'success') {
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + 30);
    
    localStorage.setItem('aura_pro', 'true');
    localStorage.setItem('aura_pro_expiry', expiryDate.toISOString());
    
    isPro = true;
    updateCredits();
    showToast('‚úÖ PRO –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ 30 –¥–Ω–µ–π!');
    
    window.history.replaceState({}, document.title, window.location.pathname);
}
</script>

</body>
</html>
