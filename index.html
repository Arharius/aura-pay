<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0e27">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Aura AI - —É–º–Ω—ã–π —Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –∑–∞–¥–∞—á –ø–æ —Ñ–æ—Ç–æ">
    <link rel="manifest" href="manifest.json">
    <title>Aura AI - –†–µ—à–µ–Ω–∏–µ –¶–î–ó</title>
    
    <style>
        :root {
            --bg: #0a0e27;
            --card: rgba(255, 255, 255, 0.05);
            --accent: #00d4ff;
            --accent2: #7000ff;
            --pro: #ffd700;
            --max-width: 600px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        html, body { overscroll-behavior-y: none; touch-action: pan-y; height: 100%; overflow: hidden; width: 100%; background: linear-gradient(135deg, #0a0e27 0%, #1a1f4b 100%); }
        body { color: white; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; display: flex; justify-content: center; }
        
        .app-container { width: 100%; max-width: var(--max-width); height: 100vh; position: relative; background: linear-gradient(135deg, #0a0e27 0%, #1a1f4b 100%); box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        
        #splash { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .splash-logo { font-size: 48px; font-weight: 900; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .loader { width: 200px; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden; margin-top: 20px; }
        .loader-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s; }
        
        .app { display: flex; flex-direction: column; height: 100vh; opacity: 0; transition: opacity 0.3s; overflow: hidden; position: relative; }
        .app.visible { opacity: 1; }
        
        header { padding: 12px 16px; background: rgba(0, 0, 0, 0.3); border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .logo { font-weight: 900; font-size: 20px; background: linear-gradient(135deg, var(--accent), var(--accent2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .credits { font-size: 12px; color: var(--accent); background: rgba(0, 212, 255, 0.1); padding: 4px 12px; border-radius: 20px; border: 1px solid rgba(0, 212, 255, 0.3); cursor: pointer; transition: all 0.2s; }
        .credits:active { transform: scale(0.95); }
        
        .mode-tabs { display: flex; gap: 8px; padding: 12px; overflow-x: auto; background: rgba(0, 0, 0, 0.2); border-bottom: 1px solid rgba(255, 255, 255, 0.1); flex-shrink: 0; }
        .mode-tab { flex-shrink: 0; padding: 8px 16px; border-radius: 20px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.6); font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .mode-tab.active { background: rgba(0, 212, 255, 0.2); color: var(--accent); border-color: var(--accent); }
        .mode-tab.pro { opacity: 0.6; }
        
        .content { flex: 1; overflow-y: auto; padding: 16px; padding-bottom: 180px; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; }
        .chat-container { display: flex; flex-direction: column; gap: 12px; }
        
        .message { max-width: 90%; padding: 14px 18px; border-radius: 18px; font-size: 15px; line-height: 1.6; animation: messageIn 0.3s ease-out; word-wrap: break-word; }
        @keyframes messageIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { background: linear-gradient(135deg, var(--accent), var(--accent2)); align-self: flex-end; border-bottom-right-radius: 4px; }
        .message.ai { background: var(--card); border: 1px solid rgba(255, 255, 255, 0.1); align-self: flex-start; border-bottom-left-radius: 4px; }
        .message img { max-width: 100%; border-radius: 8px; margin: 8px 0; max-height: 300px; object-fit: contain; display: block; }
        
        .message.ai strong { color: var(--accent); }
        .message.ai .answer-box { background: rgba(255, 215, 0, 0.1); border: 1px solid var(--pro); padding: 10px; border-radius: 8px; margin-top: 10px; display: inline-block; color: var(--pro); font-weight: bold; }
        
        .input-container { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(10, 14, 39, 0.98); backdrop-filter: blur(20px); border-top: 1px solid rgba(255, 255, 255, 0.1); padding: 12px 16px 24px 16px; z-index: 100; }
        .input-actions { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; padding-bottom: 5px; }
        .action-btn { background: rgba(255, 255, 255, 0.1); border: none; color: white; padding: 8px 14px; border-radius: 20px; font-size: 13px; display: flex; align-items: center; gap: 6px; cursor: pointer; white-space: nowrap; }
        .action-btn:active { transform: scale(0.95); background: rgba(255, 255, 255, 0.2); }
        .action-btn.clear { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; border-color: rgba(255, 107, 107, 0.3); }
        
        .input-wrapper { display: flex; gap: 10px; align-items: flex-end; background: rgba(255, 255, 255, 0.05); border-radius: 24px; padding: 8px 16px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .message-input { flex: 1; background: none; border: none; color: white; font-size: 15px; padding: 8px 0; max-height: 120px; resize: none; font-family: inherit; outline: none; }
        .message-input::placeholder { color: rgba(255, 255, 255, 0.4); }
        .send-btn { width: 36px; height: 36px; border-radius: 50%; background: var(--accent); border: none; color: #000; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; flex-shrink: 0; }
        .send-btn:disabled { opacity: 0.3; background: #666; }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.95); z-index: 1000; flex-direction: column; }
        .modal.active { display: flex; }
        .camera-preview { flex: 1; background: #000; position: relative; display: flex; align-items: center; justify-content: center; }
        .camera-preview video, .camera-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .camera-controls { padding: 20px; display: flex; justify-content: center; gap: 30px; background: rgba(0, 0, 0, 0.8); }
        .camera-btn { width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid rgba(255, 255, 255, 0.3); cursor: pointer; }
        .close-modal { position: absolute; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.5); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; z-index: 10; }
        
        .paywall { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.98); z-index: 2000; display: none; flex-direction: column; padding: 24px; overflow-y: auto; }
        .paywall.active { display: flex; }
        .paywall-title { font-size: 28px; font-weight: 900; margin-bottom: 8px; color: var(--pro); text-align: center; }
        .pricing-card { background: var(--card); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 24px; margin-bottom: 16px; border-color: var(--pro); background: rgba(255, 215, 0, 0.05); }
        .price { font-size: 32px; font-weight: 900; margin: 12px 0; }
        .price-features { list-style: none; font-size: 14px; color: rgba(255, 255, 255, 0.8); margin: 16px 0; }
        .price-features li { margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .buy-btn { width: 100%; padding: 16px; border-radius: 12px; border: none; background: linear-gradient(135deg, var(--pro), #ffed4e); color: #000; font-weight: bold; font-size: 16px; cursor: pointer; }
        
        .typing-indicator { display: none; align-self: flex-start; background: var(--card); padding: 12px 18px; border-radius: 18px; border-bottom-left-radius: 4px; align-items: center; gap: 8px; color: rgba(255, 255, 255, 0.6); }
        .typing-indicator.active { display: flex; }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dots span { width: 6px; height: 6px; background: var(--accent); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .toast { position: fixed; top: 80px; left: 50%; transform: translateX(-50%) translateY(-100px); background: rgba(0, 0, 0, 0.9); color: white; padding: 12px 24px; border-radius: 24px; font-size: 14px; z-index: 3000; transition: transform 0.3s; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        
        #file-input { display: none; }
        #offline-screen { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 9998; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        
        .content, .chat-container { user-select: none; -webkit-user-select: none; }
        .message { user-select: text; -webkit-user-select: text; }
        
        @media (min-width: 601px) {
            body { background: #050817; }
            .app-container { border-left: 1px solid rgba(255,255,255,0.1); border-right: 1px solid rgba(255,255,255,0.1); }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="offline-screen">
            <div style="font-size: 64px; margin-bottom: 20px;">üì°</div>
            <h2 style="margin-bottom: 12px; color: white;">–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h2>
            <p style="color: rgba(255,255,255,0.6); margin-bottom: 30px; max-width: 300px;">–î–ª—è —Ä–∞–±–æ—Ç—ã Aura AI —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç</p>
            <button onclick="checkConnection()" style="background: var(--accent); color: #000; border: none; padding: 12px 32px; border-radius: 24px; font-weight: bold; font-size: 16px; cursor: pointer;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
        </div>

        <div id="splash">
            <div class="splash-logo">AURA AI</div>
            <div style="color: rgba(255,255,255,0.5); font-size: 14px; margin-top: 10px;">–†–µ—à–µ–Ω–∏–µ –¶–î–ó –∏ –ì–î–ó –ø–æ —Ñ–æ—Ç–æ</div>
            <div class="loader">
                <div class="loader-bar" id="loader-bar"></div>
            </div>
        </div>

        <div class="modal" id="camera-modal">
            <button class="close-modal" onclick="closeCamera()">‚úï</button>
            <div class="camera-preview">
                <video id="camera-video" autoplay playsinline></video>
                <canvas id="camera-canvas" style="display:none;"></canvas>
            </div>
            <div class="camera-controls">
                <button class="camera-btn" onclick="takePhoto()"></button>
            </div>
        </div>

        <div class="paywall" id="paywall">
            <div style="text-align: center; margin-bottom: 24px;">
                <div class="paywall-title">üëë PRO –í–µ—Ä—Å–∏—è</div>
                <div style="color: rgba(255,255,255,0.6);">–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –≤—Å–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏</div>
            </div>
            <div class="pricing-card">
                <div style="font-size: 18px; font-weight: 700; color: var(--pro);">PRO –î–æ—Å—Ç—É–ø</div>
                <div class="price">990 ‚ÇΩ <span style="font-size: 14px; color: rgba(255,255,255,0.5);">30 –¥–Ω–µ–π</span></div>
                <ul class="price-features">
                    <li>‚úÖ –ë–µ–∑–ª–∏–º–∏—Ç–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á</li>
                    <li>‚úÖ –Æ—Ä–∏—Å—Ç (—Å–ª–æ–∂–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏)</li>
                    <li>‚úÖ –ü—Å–∏—Ö–æ–ª–æ–≥ (–≥–ª—É–±–æ–∫–∞—è —Ç–µ—Ä–∞–ø–∏—è)</li>
                    <li>‚úÖ –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä—É–∫–æ–ø–∏—Å–∏</li>
                </ul>
                <button class="buy-btn" onclick="initPayment()">–ö—É–ø–∏—Ç—å PRO</button>
            </div>
            <button onclick="closePaywall()" style="background: none; border: 1px solid rgba(255,255,255,0.2); color: rgba(255,255,255,0.6); padding: 12px; border-radius: 12px; width: 100%;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ (20/–¥–µ–Ω—å)</button>
        </div>

        <div class="app" id="app">
            <header>
                <div class="logo">AURA AI</div>
                <div style="display:flex;gap:10px;align-items:center;">
                    <div class="credits" id="credits-display" onclick="toggleAdminMode()">20/20</div>
                    <button onclick="clearChat()" style="background:rgba(255,107,107,0.2);border:1px solid rgba(255,107,107,0.3);color:#ff6b6b;padding:6px 12px;border-radius:20px;font-size:12px;cursor:pointer;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
            </header>
            <div class="mode-tabs">
                <div class="mode-tab active" onclick="setMode('tutor')" data-mode="tutor">üìö –†–µ—à–µ–Ω–∏–µ –∑–∞–¥–∞—á</div>
                <div class="mode-tab pro" onclick="setMode('lawyer')" data-mode="lawyer">‚öñÔ∏è –Æ—Ä–∏—Å—Ç</div>
                <div class="mode-tab pro" onclick="setMode('psych')" data-mode="psych">üß† –ü—Å–∏—Ö–æ–ª–æ–≥</div>
            </div>
            <div class="content" id="chat-container">
                <div class="chat-container" id="messages">
                    <div class="message ai" id="welcome-message">
                        <strong>üì∏ –†–µ—à–∞–π—Ç–µ –¶–î–ó –∏ –ì–î–ó –ø–æ —Ñ–æ—Ç–æ!</strong><br><br>
                        –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 20 —Ä–µ—à–µ–Ω–∏–π –≤ –¥–µ–Ω—å<br>
                        PRO: 990‚ÇΩ / 30 –¥–Ω–µ–π + –Æ—Ä–∏—Å—Ç + –ü—Å–∏—Ö–æ–ª–æ–≥<br><br>
                        1. –ù–∞–∂–º–∏—Ç–µ <b>–ö–∞–º–µ—Ä–∞</b> ‚Äî —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –∑–∞–¥–∞—á—É<br>
                        2. AI —Ä–µ—à–∏—Ç –µ—ë –∑–∞ 10 —Å–µ–∫—É–Ω–¥<br>
                        3. –ü–æ–ª—É—á–∏—Ç–µ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ
                    </div>
                </div>
                <div class="typing-indicator" id="typing">
                    <span>–†–µ—à–∞—é...</span>
                    <div class="typing-dots"><span></span><span></span><span></span></div>
                </div>
            </div>
            <div class="input-container">
                <div class="input-actions">
                    <button class="action-btn" onclick="openCamera()">üì∑ –ö–∞–º–µ—Ä–∞</button>
                    <button class="action-btn" onclick="document.getElementById('file-input').click()">üìé –§–∞–π–ª</button>
                    <button class="action-btn" onclick="showPaywall()">‚≠ê PRO</button>
                    <button class="action-btn clear" onclick="clearChat()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>
                <div class="input-wrapper">
                    <textarea class="message-input" id="msg-input" placeholder="–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∑–∞–¥–∞—á—É —Ç–µ–∫—Å—Ç–æ–º..." rows="1"></textarea>
                    <button class="send-btn" id="send-btn" onclick="sendMessage()">‚û§</button>
                </div>
            </div>
            <input type="file" id="file-input" accept="image/*" onchange="handleFile(event)">
        </div>
        <div class="toast" id="toast"></div>
    </div>

    <script>
        // –ë–õ–û–ö–ò–†–û–í–ö–ê PULL-TO-REFRESH
        (function () {
            let startY = 0;
            document.addEventListener('touchstart', function (e) {
                if (e.touches.length === 1) startY = e.touches[0].clientY;
            }, { passive: true });

            document.addEventListener('touchmove', function (e) {
                if (e.touches.length !== 1) return;
                const y = e.touches[0].clientY;
                const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                if (scrollTop <= 0 && y > startY) {
                    e.preventDefault();
                    return false;
                }
            }, { passive: false });

            document.body.style.overscrollBehavior = 'none';
        })();

        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRndW1naGdvd2V4Y3V6bG5xbm9hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNTAzNTEsImV4cCI6MjA4NjcyNjM1MX0.PWSpyTL8w4s567OeulBrmhm3x7T-nqrvfeE0Cp8Jcbw';

        const CONFIG = {
            SUPABASE_URL: 'https://tgumghgowexcuzlnqnoa.supabase.co',
            SUPABASE_KEY: SUPABASE_KEY,
            DAILY_LIMIT: 20,
            MODES: {
                tutor: { name: '–†–µ–ø–µ—Ç–∏—Ç–æ—Ä', free: true, system: '–¢—ã —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–µ—à–µ–Ω–∏—é —à–∫–æ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á (–¶–î–ó, –ì–î–ó). –†–µ—à–∞–π –ø–æ—à–∞–≥–æ–≤–æ, –æ–±—ä—è—Å–Ω—è–π –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —ç—Ç–∏ —Å–∏–º–≤–æ–ª—ã –¥–ª—è —Ñ–æ—Ä–º—É–ª: ‚àö, ¬∞, ‚à†, ¬≤, ¬≥, √ó, √∑. –ù–∏–∫–∞–∫–æ–≥–æ LaTeX (–±–µ–∑ \\frac, \\sqrt). –û—Ç–≤–µ—Ç –≤—ã–¥–µ–ª–∏ —Å–ª–æ–≤–æ–º "–û—Ç–≤–µ—Ç:".' },
                lawyer: { name: '–Æ—Ä–∏—Å—Ç', free: false, system: '–¢—ã —Å—Ç–∞—Ä—à–∏–π —é—Ä–∏—Å—Ç —Å 15-–ª–µ—Ç–Ω–∏–º —Å—Ç–∞–∂–µ–º –≤ –†–§. –î–∞–≤–∞–π –î–ï–¢–ê–õ–¨–ù–´–ï –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ —Å—Ç–∞—Ç—å—è–º–∏ –ì–ö –†–§, –ù–ö –†–§, –¢–ö –†–§. –î–∞–≤–∞–π —Å—Ä–æ–∫–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏.' },
                psych: { name: '–ü—Å–∏—Ö–æ–ª–æ–≥', free: false, system: '–¢—ã –∫–ª–∏–Ω–∏—á–µ—Å–∫–∏–π –ø—Å–∏—Ö–æ–ª–æ–≥, —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç –ø–æ –ö–ü–¢. –ü—Ä–æ–≤–æ–¥–∏ —Ç–µ—Ä–∞–ø–∏—é: –¥–∞–≤–∞–π –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è, –¥–Ω–µ–≤–Ω–∏–∫–∏ –º—ã—Å–ª–µ–π, —Ç–µ—Ö–Ω–∏–∫–∏ —Å–∞–º–æ–ø–æ–º–æ—â–∏. –ì–ª—É–±–∏–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞.' }
            }
        };

        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        let currentMode = 'tutor';
        let messageCount = 0;
        let stream = null;
        let isPro = false;
        let isAdmin = false; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –í–´–ö–õ–Æ–ß–ï–ù

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function initApp() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ PRO
            const proExpiry = localStorage.getItem('aura_pro_expiry');
            if (proExpiry) {
                const expiryDate = new Date(proExpiry);
                if (new Date() <= expiryDate) {
                    isPro = true;
                } else {
                    localStorage.removeItem('aura_pro');
                    localStorage.removeItem('aura_pro_expiry');
                }
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ê–¥–º–∏–Ω–∞ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —è–≤–Ω–æ –≤–∫–ª—é—á–µ–Ω–æ)
            if (localStorage.getItem('aura_admin') === 'true') {
                isAdmin = true;
                console.log('üîë ADMIN MODE');
            }
        }

        initApp();

        function updateOnlineStatus() {
            const offlineScreen = document.getElementById('offline-screen');
            if (offlineScreen) {
                offlineScreen.style.display = navigator.onLine ? 'none' : 'flex';
            }
        }

        function checkConnection() {
            if (navigator.onLine) {
                updateOnlineStatus();
                showToast('‚úÖ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –µ—Å—Ç—å');
            } else {
                showToast('‚ùå –ù–µ—Ç —Å–≤—è–∑–∏');
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        window.addEventListener('beforeunload', function () {
            const messagesEl = document.getElementById('messages');
            if (messagesEl) {
                localStorage.setItem('aura_chat_backup', JSON.stringify({
                    html: messagesEl.innerHTML,
                    mode: currentMode,
                    count: messageCount,
                    time: new Date().toISOString()
                }));
            }
        });

        // –ë–ï–ó–û–ü–ê–°–ù–´–ô –ü–ê–†–°–ò–ù–ì JSON
        function safeJSONParse(str) {
            try {
                return JSON.parse(str);
            } catch (e) {
                return null;
            }
        }

        // –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –û–®–ò–ë–û–ö (–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –±–µ–∑ [object Object])
        function formatError(error) {
            if (!error) return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            
            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞
            if (typeof error === 'string') return error;
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å message –∏ —ç—Ç–æ –Ω–µ [object Object]
            if (error.message && typeof error.message === 'string' && error.message !== '[object Object]') {
                return error.message;
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å error.error
            if (error.error) {
                if (typeof error.error === 'string') return error.error;
                if (error.error.message) return error.error.message;
                return JSON.stringify(error.error);
            }
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å error.message –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ Supabase
            if (error.msg) return error.msg;
            
            // –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - stringify —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
            try {
                const str = JSON.stringify(error);
                if (str !== '{}' && str !== '[object Object]') return str;
                return '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.';
            } catch (e) {
                return '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
            }
        }

        function cleanLatex(text) {
            if (!text) return '';
            if (typeof text !== 'string') text = String(text);
            
            return text
                .replace(/\\[\[\]\(\)]/g, '')
                .replace(/\(([a-zA-Z0-9‚àö\s]+)\/\(([a-zA-Z0-9‚àö\s]+)\)\)/g, '$1/$2')
                .replace(/\(([a-zA-Z0-9‚àö\s]+)\/([a-zA-Z0-9‚àö\s]+)\)/g, '$1/$2')
                .replace(/(sin|cos|tg|ctg)\(([A-Z0-9¬∞]+)\)/g, '$1 $2')
                .replace(/\s*=\s*=\s*/g, ' = ')
                .replace(/\\/g, '')
                .replace(/\.{4,}/g, '...')
                .replace(/\s+$/gm, '')
                .replace(/frac\{([^}]+)\}\{([^}]+)\}/g, '($1/$2)')
                .replace(/sqrt\{([^}]+)\}/g, '‚àö$1')
                .replace(/sqrt/g, '‚àö')
                .replace(/angle/g, '‚à†')
                .replace(/degrees?/g, '¬∞')
                .replace(/cdot|times/g, '√ó')
                .replace(/div/g, '√∑')
                .replace(/pi/g, 'œÄ')
                .replace(/alpha/g, 'Œ±')
                .replace(/beta/g, 'Œ≤')
                .replace(/gamma/g, 'Œ≥')
                .replace(/boxed\{([^}]+)\}/g, '<div class="answer-box">üì¶ –û—Ç–≤–µ—Ç: $1</div>')
                .replace(/\n\n\n+/g, '\n\n')
                .trim();
        }

        window.onload = () => {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW error:', err));
            }

            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞
            const savedChat = localStorage.getItem('aura_chat_backup');
            if (savedChat) {
                try {
                    const chatData = JSON.parse(savedChat);
                    const hoursDiff = (new Date() - new Date(chatData.time)) / (1000 * 60 * 60);
                    if (hoursDiff < 24 && chatData.html) {
                        const messagesEl = document.getElementById('messages');
                        if (messagesEl) messagesEl.innerHTML = chatData.html;
                    }
                } catch (e) {
                    console.error('Error loading chat:', e);
                }
            }

            updateOnlineStatus();
            
            // –°—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            const today = new Date().toDateString();
            messageCount = parseInt(localStorage.getItem(`usage_${today}`) || '0');
            updateCredits();

            // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
            let progress = 0;
            const interval = setInterval(() => {
                progress += 20;
                const bar = document.getElementById('loader-bar');
                if (bar) bar.style.width = progress + '%';
                if (progress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        const splash = document.getElementById('splash');
                        if (splash) {
                            splash.style.opacity = '0';
                            setTimeout(() => splash.remove(), 500);
                        }
                        const app = document.getElementById('app');
                        if (app) app.classList.add('visible');
                    }, 500);
                }
            }, 200);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞
            const msgInput = document.getElementById('msg-input');
            if (msgInput) {
                msgInput.addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });

                msgInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        };

        function setMode(mode) {
            const modeConfig = CONFIG.MODES[mode];
            if (!modeConfig) return;
            
            if (!modeConfig.free && !isPro && !isAdmin) {
                showPaywall();
                return;
            }
            currentMode = mode;
            document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
            const tab = document.querySelector(`[data-mode="${mode}"]`);
            if (tab) tab.classList.add('active');
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞ (–≤–∫–ª/–≤—ã–∫–ª)
        function toggleAdminMode() {
            if (isAdmin) {
                localStorage.removeItem('aura_admin');
                isAdmin = false;
                showToast('üîí ADMIN –≤—ã–∫–ª—é—á–µ–Ω');
            } else {
                // –î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –Ω—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª—å: localStorage.setItem('aura_admin', 'true')
                showToast('–î–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è ADMIN –≤–≤–µ–¥–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª—å: localStorage.setItem("aura_admin", "true")');
            }
            updateCredits();
        }

        async function sendMessage() {
            if (!navigator.onLine) {
                showToast('–ù–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞');
                const offlineEl = document.getElementById('offline-screen');
                if (offlineEl) offlineEl.style.display = 'flex';
                return;
            }

            const input = document.getElementById('msg-input');
            const sendBtn = document.getElementById('send-btn');
            const typing = document.getElementById('typing');
            
            if (!input) return;
            
            const text = input.value.trim();
            if (!text) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
            if (!isPro && !isAdmin && messageCount >= CONFIG.DAILY_LIMIT) {
                showToast('–õ–∏–º–∏—Ç 20 —Ä–µ—à–µ–Ω–∏–π/–¥–µ–Ω—å');
                showPaywall();
                return;
            }

            if (navigator.vibrate) navigator.vibrate(50);

            addMessage(text, 'user');
            input.value = '';
            input.style.height = 'auto';

            if (typing) typing.classList.add('active');
            if (sendBtn) sendBtn.disabled = true;

            try {
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:', text);
                
                const response = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/solve-task`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        mode: currentMode,
                        message: text,
                        system: CONFIG.MODES[currentMode].system,
                        user_pro: isPro || isAdmin
                    })
                });

                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
                const responseText = await response.text();
                console.log('–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:', responseText);
                
                if (!response.ok) {
                    // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –∫–∞–∫ JSON
                    const errorData = safeJSONParse(responseText) || { error: responseText || `HTTP ${response.status}` };
                    throw errorData;
                }

                // –ü–∞—Ä—Å–∏–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
                const data = safeJSONParse(responseText);
                if (!data) {
                    throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                if (typing) typing.classList.remove('active');

                if (data.error) {
                    throw data;
                }
                
                if (!data.answer) {
                    throw new Error('–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
                addMessage(cleanLatex(data.answer), 'ai');

                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                if (!isPro && !isAdmin) {
                    messageCount++;
                    localStorage.setItem(`usage_${new Date().toDateString()}`, messageCount);
                    updateCredits();
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ sendMessage:', error);
                if (typing) typing.classList.remove('active');
                addMessage('‚ùå –û—à–∏–±–∫–∞: ' + formatError(error), 'ai');
            } finally {
                if (sendBtn) sendBtn.disabled = false;
            }
        }

        async function takePhoto() {
            const video = document.getElementById('camera-video');
            const canvas = document.getElementById('camera-canvas');
            
            if (!video || !canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth || 1280;
            canvas.height = video.videoHeight || 720;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            closeCamera();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
            if (!isPro && !isAdmin && messageCount >= CONFIG.DAILY_LIMIT) {
                showToast('–õ–∏–º–∏—Ç 20 —Ä–µ—à–µ–Ω–∏–π/–¥–µ–Ω—å');
                showPaywall();
                return;
            }

            addMessage('[üì∑ –§–æ—Ç–æ –∑–∞–¥–∞—á–∏]', 'user', imageData);
            showToast('üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...');
            
            const typing = document.getElementById('typing');
            if (typing) typing.classList.add('active');

            try {
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ...');
                
                const response = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/solve-vision`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({ 
                        imageBase64: imageData, 
                        mode: currentMode 
                    })
                });

                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    const errorData = safeJSONParse(errorText) || { error: errorText || `HTTP ${response.status}` };
                    throw errorData;
                }

                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–æ–∫–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (stream)
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                // –°–æ–∑–¥–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ—Ç–æ–∫–∞
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message ai';
                msgDiv.innerHTML = '<em>–î—É–º–∞—é...</em>';
                const messagesEl = document.getElementById('messages');
                if (messagesEl) messagesEl.appendChild(msgDiv);
                
                if (typing) typing.classList.remove('active');
                
                let fullText = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–µ–ø–æ–ª–Ω—É—é —Å—Ç—Ä–æ–∫—É
                    
                    for (const line of lines) {
                        if (line.startsWith('data:')) {
                            const jsonStr = line.replace('data:', '').trim();
                            if (jsonStr === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(jsonStr);
                                const content = parsed.choices?.[0]?.delta?.content || 
                                               parsed.choices?.[0]?.text || 
                                               parsed.content || '';
                                if (content) {
                                    fullText += content;
                                    msgDiv.innerHTML = cleanLatex(fullText);
                                    const chatContainer = document.getElementById('chat-container');
                                    if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
                                }
                            } catch (e) {
                                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –±–∏—Ç—ã–µ JSON –≤ –ø–æ—Ç–æ–∫–µ
                            }
                        }
                    }
                }
                
                // –§–∏–Ω–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
                if (buffer.startsWith('data:')) {
                    try {
                        const jsonStr = buffer.replace('data:', '').trim();
                        if (jsonStr !== '[DONE]') {
                            const parsed = JSON.parse(jsonStr);
                            const content = parsed.choices?.[0]?.delta?.content || '';
                            if (content) fullText += content;
                        }
                    } catch (e) {}
                }
                
                msgDiv.innerHTML = cleanLatex(fullText) || '<em>–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞</em>';

                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
                if (!isPro && !isAdmin) {
                    messageCount++;
                    localStorage.setItem(`usage_${new Date().toDateString()}`, messageCount);
                    updateCredits();
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ takePhoto:', error);
                if (typing) typing.classList.remove('active');
                addMessage('‚ùå –û—à–∏–±–∫–∞: ' + formatError(error), 'ai');
            }
        }

        async function openCamera() {
            if (currentMode !== 'tutor' && !isPro && !isAdmin) {
                showToast('–ö–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —Ä–µ–∂–∏–º–µ –†–µ–ø–µ—Ç–∏—Ç–æ—Ä–∞ –∏–ª–∏ PRO');
                showPaywall();
                return;
            }
            
            const modal = document.getElementById('camera-modal');
            if (modal) modal.classList.add('active');
            
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: false 
                });
                const video = document.getElementById('camera-video');
                if (video) video.srcObject = stream;
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã:', err);
                showToast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
                closeCamera();
            }
        }

        function closeCamera() {
            const modal = document.getElementById('camera-modal');
            if (modal) modal.classList.remove('active');
            if (stream) { 
                stream.getTracks().forEach(track => track.stop()); 
                stream = null; 
            }
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) { 
                showToast('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 5MB)'); 
                return; 
            }
            
            if (!file.type.startsWith('image/')) {
                showToast('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ñ–æ—Ç–æ');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                processImage(e.target.result);
            };
            reader.onerror = () => {
                showToast('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
            };
            reader.readAsDataURL(file);
            event.target.value = '';
        }

        async function processImage(imageData) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
            if (!isPro && !isAdmin && messageCount >= CONFIG.DAILY_LIMIT) {
                showToast('–õ–∏–º–∏—Ç 20 —Ä–µ—à–µ–Ω–∏–π/–¥–µ–Ω—å');
                showPaywall();
                return;
            }

            addMessage('[üì∑ –§–æ—Ç–æ –∏–∑ –≥–∞–ª–µ—Ä–µ–∏]', 'user', imageData);
            showToast('üîç –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...');
            
            const typing = document.getElementById('typing');
            const sendBtn = document.getElementById('send-btn');
            
            if (typing) typing.classList.add('active');
            if (sendBtn) sendBtn.disabled = true;

            try {
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –≥–∞–ª–µ—Ä–µ–∏...');
                
                const response = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/solve-vision`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        imageBase64: imageData,
                        mode: currentMode,
                        user_pro: isPro || isAdmin
                    })
                });

                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    const errorData = safeJSONParse(errorText) || { error: errorText || `HTTP ${response.status}` };
                    throw errorData;
                }
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ—Ç–æ–∫–∞ (—Ç–∞–∫ –∂–µ –∫–∞–∫ –≤ takePhoto)
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                const msgDiv = document.createElement('div');
                msgDiv.className = 'message ai';
                msgDiv.innerHTML = '<em>–î—É–º–∞—é...</em>';
                const messagesEl = document.getElementById('messages');
                if (messagesEl) messagesEl.appendChild(msgDiv);
                
                if (typing) typing.classList.remove('active');
                if (sendBtn) sendBtn.disabled = false;
                
                let fullText = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.startsWith('data:')) {
                            const jsonStr = line.replace('data:', '').trim();
                            if (jsonStr === '[DONE]') continue;
                            
                            try {
                                const parsed = JSON.parse(jsonStr);
                                const content = parsed.choices?.[0]?.delta?.content || '';
                                if (content) {
                                    fullText += content;
                                    msgDiv.innerHTML = cleanLatex(fullText);
                                    const chatContainer = document.getElementById('chat-container');
                                    if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
                                }
                            } catch (e) {}
                        }
                    }
                }
                
                if (buffer.startsWith('data:')) {
                    try {
                        const jsonStr = buffer.replace('data:', '').trim();
                        if (jsonStr !== '[DONE]') {
                            const parsed = JSON.parse(jsonStr);
                            const content = parsed.choices?.[0]?.delta?.content || '';
                            if (content) fullText += content;
                        }
                    } catch (e) {}
                }
                
                msgDiv.innerHTML = cleanLatex(fullText) || '<em>–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞</em>';

                if (!isPro && !isAdmin) {
                    messageCount++;
                    localStorage.setItem(`usage_${new Date().toDateString()}`, messageCount);
                    updateCredits();
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ processImage:', error);
                if (typing) typing.classList.remove('active');
                if (sendBtn) sendBtn.disabled = false;
                addMessage('‚ùå –û—à–∏–±–∫–∞: ' + formatError(error), 'ai');
                showToast('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å');
            }
        }

        async function initPayment() {
            showToast('–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞...');
            try {
                const userId = localStorage.getItem('user_id') || 'user_' + Date.now();
                localStorage.setItem('user_id', userId);

                const response = await fetch(`${CONFIG.SUPABASE_URL}/functions/v1/create-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        return_url: window.location.href.split('?')[0] + '?payment=success'
                    })
                });

                const responseText = await response.text();
                const data = safeJSONParse(responseText) || {};
                
                if (!response.ok) {
                    throw data.error || data.message || responseText || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞';
                }
                
                if (data.confirmation_url) {
                    window.location.href = data.confirmation_url;
                } else {
                    throw '–ù–µ –ø–æ–ª—É—á–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É';
                }

            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã:', err);
                showToast('–û—à–∏–±–∫–∞: ' + formatError(err));
            }
        }

        function addMessage(content, type, image = null) {
            const messagesEl = document.getElementById('messages');
            if (!messagesEl) return;
            
            const div = document.createElement('div');
            div.className = `message ${type}`;
            
            if (image && type === 'user') {
                div.innerHTML = `<img src="${image}" alt="–§–æ—Ç–æ –∑–∞–¥–∞—á–∏" style="max-width:100%;border-radius:8px;margin-bottom:8px;">${content}`;
            } else {
                div.innerHTML = content;
            }
            
            messagesEl.appendChild(div);
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer) chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function updateCredits() {
            const el = document.getElementById('credits-display');
            if (!el) return;
            
            if (isAdmin) {
                el.textContent = 'ADMIN';
                el.style.color = '#ffd700';
                el.style.borderColor = '#ffd700';
                el.style.background = 'rgba(255, 215, 0, 0.2)';
                return;
            }
            
            if (isPro) {
                el.textContent = '‚àû/‚àû';
                el.style.color = 'var(--accent)';
                el.style.borderColor = 'rgba(0, 212, 255, 0.3)';
                el.style.background = 'rgba(0, 212, 255, 0.1)';
                return;
            }
            
            const remaining = Math.max(0, CONFIG.DAILY_LIMIT - messageCount);
            el.textContent = `${remaining}/${CONFIG.DAILY_LIMIT}`;
            
            if (remaining <= 3) {
                el.style.color = '#ff1744';
                el.style.borderColor = '#ff1744';
                el.style.background = 'rgba(255, 23, 68, 0.1)';
            } else if (remaining <= 5) {
                el.style.color = '#ffa500';
                el.style.borderColor = 'rgba(255, 165, 0, 0.5)';
            } else {
                el.style.color = 'var(--accent)';
                el.style.borderColor = 'rgba(0, 212, 255, 0.3)';
                el.style.background = 'rgba(0, 212, 255, 0.1)';
            }
        }

        function showPaywall() { 
            const el = document.getElementById('paywall');
            if (el) el.classList.add('active'); 
        }
        
        function closePaywall() { 
            const el = document.getElementById('paywall');
            if (el) el.classList.remove('active'); 
        }
        
        function showToast(msg) { 
            const t = document.getElementById('toast'); 
            if (!t) return;
            t.textContent = msg; 
            t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), 3000); 
        }

        function clearChat() {
            if(!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞? –°—á–µ—Ç—á–∏–∫ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º.')) return;
            
            localStorage.removeItem('aura_chat_backup');
            
            const messagesEl = document.getElementById('messages');
            if (messagesEl) {
                messagesEl.innerHTML = `
                    <div class="message ai" id="welcome-message">
                        <strong>üì∏ –†–µ—à–∞–π—Ç–µ –¶–î–ó –∏ –ì–î–ó –ø–æ —Ñ–æ—Ç–æ!</strong><br><br>
                        –ë–µ—Å–ø–ª–∞—Ç–Ω–æ: 20 —Ä–µ—à–µ–Ω–∏–π –≤ –¥–µ–Ω—å<br>
                        PRO: 990‚ÇΩ / 30 –¥–Ω–µ–π + –Æ—Ä–∏—Å—Ç + –ü—Å–∏—Ö–æ–ª–æ–≥<br><br>
                        1. –ù–∞–∂–º–∏—Ç–µ <b>–ö–∞–º–µ—Ä–∞</b> ‚Äî —Å—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –∑–∞–¥–∞—á—É<br>
                        2. AI —Ä–µ—à–∏—Ç –µ—ë –∑–∞ 10 —Å–µ–∫—É–Ω–¥<br>
                        3. –ü–æ–ª—É—á–∏—Ç–µ –ø–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ
                    </div>
                `;
            }
            
            showToast('‚úÖ –ß–∞—Ç –æ—á–∏—â–µ–Ω');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('payment') === 'success') {
            const expiryDate = new Date();
            expiryDate.setDate(expiryDate.getDate() + 30);
            localStorage.setItem('aura_pro', 'true');
            localStorage.setItem('aura_pro_expiry', expiryDate.toISOString());
            isPro = true;
            updateCredits();
            showToast('‚úÖ PRO –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –Ω–∞ 30 –¥–Ω–µ–π!');
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>
</body>
</html>
